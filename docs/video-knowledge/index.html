<!DOCTYPE html>
<html lang="en-US">
<link rel="stylesheet" href="/css/gallery.css">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="I&rsquo;m a software engineer borned in 2000. Love my work and life.">
<meta name="author" content="Caiyi Zhang">

<title>Video Knowledge · CaiyiZhang&rsquo;s Blog</title>

<link rel="canonical" href="/docs/video-knowledge/">




  <link rel="stylesheet" href="/assets/css/docs.min.dcabf270c88fb205b746f7955d094e4fc1571e71c6ecb2549658cc810d16e4cf.css" integrity="">




  <link rel="preconnect" href="https://-dsn.algolia.net" crossorigin />
  
  <link rel="stylesheet" href="/css/component/docsearch.min.cb5a1c417ef755c9bf17808583cb389f7f745310f105256d2c11714b3cfad6df.css" integrity=""/>

<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/img/icon/favicon.ico">
<link rel="icon" href="/img/icon/icon-16.png" sizes="16x16" type="image/png">
<link rel="icon" href="/img/icon/icon-32.png" sizes="32x32" type="image/png">
<link rel="apple-touch-icon" href="/img/icon/icon-180.png" sizes="180x180">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-XXXXXXXXXX');
  </script>


  

  </head>
  <body>
    <header id="site-header">
  
  <div id="site-header-brand">
    <a href="/">CaiyiZhang&#39;s Blog</a>
  </div>

  
  <div id="site-header-controls">
    
    <div class="dropdown">
      <button class="dropdown-btn" aria-haspopup="menu" aria-label="theme selector">
        <i class="icon icon-brightness"></i>
        <i class="icon icon-select"></i>
      </button>
      <ul role="menu" class="dropdown-menu">
        <li role="menuitem"><button class="color-scheme" data-value="light"><i class="icon icon-light-mode"></i> Light</button></li>
        <li role="menuitem"><button class="color-scheme" data-value="dark"><i class="icon icon-dark-mode"></i> Dark &nbsp;</button></li>
        <li role="menuitem"><button class="color-scheme" data-value="night"><i class="icon icon-night-mode"></i> Night</button></li>
      </ul>
    </div>

  </div>

  
  <div id="site-header-menu">
    <nav>
      <ul>
        
        
        
          
          <li><a href="/" ><i class='icon icon-home'></i>Home</a></li>
        
          
          <li><a href="/docs"  class="active"><i class='icon icon-book'></i>Blogs</a></li>
        
          
          <li><a href="/life" ><i class='icon icon-dark-mode'></i>Life</a></li>
        
      </ul>
    </nav>
  </div>

  
  <div id="site-header-search"></div>
</header>
    
<div id="site-main-content-wrapper">
  
  
    


<aside id="sidebar">
  <span class="btn-close"><i class="icon icon-close"></i></span>

  <div class="sticky"><strong class="sidebar-section">Overview</strong>
          
          <a class="sidebar-link " href="/docs/aboutme/">
            
              AboutMe
            
          </a>

        <strong class="sidebar-section">Languages</strong>
          
          <a class="sidebar-link " href="/docs/java-basic/">
            
              Java Basic
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/java-advance/">
            
              Java Advance
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/java-data-structure/">
            
              Java Data Structure
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/java-input-output/">
            
              Java Input-Output
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/python-basic/">
            
              Python Basic
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/java-native-interface/">
            
              Java Native Interface
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/c-plus-plus/">
            
              C plus plus
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/javascript/">
            
              JavaScript
            
          </a>

        <strong class="sidebar-section">Computer Science</strong>
          
          <a class="sidebar-link " href="/docs/github-usage/">
            
              Github Usage
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/computer-network/">
            
              Computer Network
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/operating-system/">
            
              Operating System
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/database-principal/">
            
              Database Principal
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/software-testing/">
            
              Software Testing
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/functional-programing/">
            
              Functional Programing
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/object-oriented-design/">
            
              Object-Oriented Design
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/compiler-principles/">
            
              Compiler Principles
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/linux-operation/">
            
              Linux Operation
            
          </a>

        <strong class="sidebar-section">Video Develop</strong>
          
          <a class="sidebar-link " href="/docs/ffmpeg/">
            
              FFMpeg
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/android-camera-2/">
            
              Android Camera 2
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/video-compression/">
            
              Video Compression
            
          </a>

        
          
          <a class="sidebar-link current" href="/docs/video-knowledge/">
            
              Video Knowledge
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/andriod-development/">
            
              Andriod Development
            
          </a>

        <strong class="sidebar-section">Backend Develop</strong>
          
          <a class="sidebar-link " href="/docs/express/">
            
              Express
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/fast-api/">
            
              Fast API
            
          </a>

        <strong class="sidebar-section">Frontend Develop</strong>
          
          <a class="sidebar-link " href="/docs/html5/">
            
              HTML5
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/css3/">
            
              CSS3
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/vue-js/">
            
              Vue js
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/react-js/">
            
              React js
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/react-native/">
            
              React Native
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/mern-e-commerce/">
            
              MERN E-Commerce
            
          </a>

        
  </div>
</aside>

  
  <main>
    <article id="article">
      <nav id="article-nav">
  <button id="article-nav-menu-btn"><i class="icon icon-menu"></i> On this section</button>
  <button id="article-nav-toc-btn"><i class="icon icon-toc"></i> On this page</button>
</nav>
      <header id="article-header">
  <h1>Video Knowledge</h1>
</header>
      <div id="article-content">
        
        
        <h1 id="video-development">Video development</h1>
<h1 id="domin-knowledge">Domin Knowledge</h1>
<ol>
<li>语言基础  C, C++, Java, JNI</li>
<li>视频图像基础  MP4 格式, YUV 格式, FLV 格式, IBP 帧，常见的性能指标</li>
<li>音视频传输协议  WebRTC, RTP, RTCP, RTSP, RTMP, UDP</li>
<li>视频编解码协议  H264, H265, AAC, AV1, VP9, Opus, HEVC</li>
<li>开源多媒体处理框架  FFMpeg, x264</li>
<li>客户端多媒体相关sdk  Android camera 2, Media codec, iOS AV foundation, Media Capture, Media Foundation, Direct Show, OpenGL ES, GPU Image, Metal</li>
<li>客户端开发  Android native, iOS native, Xamarin</li>
<li>音视频质量优化  jitter buffer, SVC, GCC, FEC, simulcast</li>
<li>找一个实战项目，包含以下功能
<ul>
<li>
<p>功能 list</p>
<ul>
<li>播放/暂停</li>
<li>变速播放</li>
<li>调节音量</li>
<li>上一/下一视频</li>
<li>显示播放列表</li>
<li>显示缓存时间</li>
<li>实现直播低延迟播放</li>
<li>硬件解码、软件解码切换</li>
<li>多路视频同时播放，比如1080p播放25路</li>
<li>4k/8k渲染的区别</li>
<li>加密解密功能</li>
<li>登录授权功能</li>
<li>播放状态监测功能</li>
</ul>
</li>
<li>
<p>项目列表</p>
<p><a href="https://www.udemy.com/course/mastering-webrtc-part-2-real-time-video-and-screen-share/" target="_blank">https://www.udemy.com/course/mastering-webrtc-part-2-real-time-video-and-screen-share/</a></p>
<p><a href="https://www.udemy.com/course/webrtc-2021-practical-course-create-meet-the-strangers-app/" target="_blank">https://www.udemy.com/course/webrtc-2021-practical-course-create-meet-the-strangers-app/</a></p>
<p><a href="https://www.udemy.com/course/the-complete-android-machine-learning-course/?couponCode=OF83024E" target="_blank">https://www.udemy.com/course/the-complete-android-machine-learning-course/?couponCode=OF83024E</a></p>
</li>
</ul>
</li>
</ol>
<h1 id="detail-for-interview">Detail for interview</h1>
<h2 id="1-语言基础"><strong>1. 语言基础</strong></h2>
<h2 id="2-图像视频基础">2. 图像视频基础</h2>
<ul>
<li>
<p>图像的参数：像素, 分辨率, 位深, 跨距</p>
<ul>
<li>
<p>**像素：**像素是图像的基本单元，一个个像素就组成了图像</p>
</li>
<li>
<p>**分辨率：**指图像由多少个像素组成，分辨率越高就越清晰。一张 1920x1080 的图像，指的是该图像的宽度方向上有 1920 个像素点，高度方向上有 1080 个像素点</p>
<p>常见的分辨率有 QCIF（176x144）、CIF（352x288）、360P（640x360）、720P（1280x720）、1080P（1920x1080）、4K（3840x2160）</p>
<p><img src="Untitled.png" alt="Untitled"></p>
</li>
<li>
<p>**位深：**存储每个像素需要的二进制位数，位深越大，颜色值越多，色彩越丰富</p>
<p>常见图像由红绿蓝（RGB）三种颜色通道组成，每个通道用 8 位 (1 字节，表示 256 种颜色，即 2 的 8 次方) 表示，一个像素共占 24 位(3 字节，表示 1677 万种颜色，即 256 的 3 次方)。这类图像通常被称为 8bit 图像，其中的 8bit 指的就是每个通道的位深</p>
<table>
  <thead>
      <tr>
          <th><strong>类型</strong></th>
          <th><strong>每通道位数</strong></th>
          <th><strong>总颜色种类</strong></th>
          <th><strong>特点与用途</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>1 位图像</strong></td>
          <td>1 位</td>
          <td>2 种颜色（黑/白）</td>
          <td>二值图（如扫描文档）</td>
      </tr>
      <tr>
          <td><strong>8 位彩色图像</strong></td>
          <td>每通道 8 位，共 24 位</td>
          <td>1677 万色</td>
          <td>最常见的图像格式</td>
      </tr>
      <tr>
          <td><strong>10 位图像</strong></td>
          <td>每通道 10 位，共 30 位</td>
          <td>~10 亿种颜色</td>
          <td>HDR 视频、电影制作</td>
      </tr>
      <tr>
          <td><strong>12 位图像</strong></td>
          <td>每通道 12 位，共 36 位</td>
          <td>更高色彩细节</td>
          <td>专业摄影、医疗图像</td>
      </tr>
      <tr>
          <td><strong>16 位图像</strong></td>
          <td>每通道 16 位，共 48 位</td>
          <td>超过 280 万亿种颜色</td>
          <td>天文、工业、科学级图像</td>
      </tr>
      <tr>
          <td><strong>32 位图像</strong></td>
          <td>24 位 RGB + 8 位 Alpha</td>
          <td>带透明通道</td>
          <td>UI 图像、PNG 格式</td>
      </tr>
      <tr>
          <td><strong>高动态范围图像 HDR</strong></td>
          <td>通常为 10/12/16 位浮点</td>
          <td>光线更丰富的场景</td>
          <td>视频 HDR10, Dolby Vision</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>**跨距 Stride：**图像存储时，内存中每行像素所占用的对齐后的空间</p>
<p>一张 1278×720 的 RGB 图像，每个像素占 3 字节，一行共需 1278 × 3 = 3834 字节。但 3834 不是 16 的倍数，不满足内存对齐要求。为了对齐，会在每行末尾补齐到 3840 字节（补 6 字节），这就叫做 <strong>stride = 3840</strong>。读取图像时，若不跳过这多出的字节，就会把它们误当成下一行的像素，导致图像显示异常，比如花屏、斜线等问题</p>
<p><img src="Untitled%201.png" alt="Untitled"></p>
</li>
</ul>
</li>
<li>
<p>视频的参数：帧率、丢帧率、码率、编码格式、封装格式、峰值信噪比</p>
<ul>
<li><strong>帧率</strong>：每秒播放多少帧图像，帧率越高，画面越流畅。24fps 普通、30fps 电影、60fps 游戏</li>
<li>**丢帧率：**视频播放中未能按时显示的帧数比例，丢帧率越高，视频会越卡顿</li>
<li><strong>码率</strong>：表示每秒传输的数据量，单位 kbps/Mbps，码率越高，每一帧图像数据越大，越清晰越流畅，细节更丰富，但传输时占用带宽也更大，码率 = 分辨率 × fps × 每像素位数 × 压缩比</li>
<li><strong>编码格式</strong>：把原始视频压缩存储的方式，常见格式有 H.264(AVC)、H.265(HEVC)、AV1，H.265 比 H.264 更高效，同样画质下占用更少带宽</li>
<li>**封装格式：**将视频、音频、字幕等打包在一起的文件格式，比如 MP4、MKV、MOV、FLV 等</li>
<li><strong>峰值信噪比 (PSNR)</strong>: 计算压缩视频帧与原始图像间的误差大小，PSNR 越高误差越小，质量越好</li>
</ul>
<hr>
</li>
<li>
<p>图像颜色空间：YUV，RGB，HSV，full / limited range</p>
<p>RGB 适合屏幕显示渲染，YUV 适合压缩和传输， HSV 适合调色和图像处理</p>
<ul>
<li>
<p><strong>RGB</strong></p>
<p>每一个像素由 Red, Green, Blue 三个值加权组成。适合用于显示设备，比如手机屏幕、显示器、摄像头预览。RGB 中每个颜色分量通常用 8 位表示，组合后能表示一千六百万种颜色</p>
<p>注意 RGB 图像像素三个值并不一定是按 R、G、B 顺序排列的，也有可能是 B、G、R 顺序排列。比如 OpenCV 就经常使用 BGR 的排列方式来存储图像</p>
</li>
<li>
<p><strong>YUV</strong></p>
<p>Y (Luma) 是亮度信息表示总体轮廓，U (Chroma Blue) V (Chroma Red) 描绘图像的色彩信息。YUV 最早主要是用于电视系统与模拟视频领域，现在的视频领域也基本是用 YUV 来表示图像。人眼对亮度更敏感，对色度不敏感，因此可以压缩色度数据而不明显降低画质，常用于视频压缩和传输，例如摄像头输出、视频编码和硬件加速。YUV 常见的排列格式有 YUV420、YUV422、NV12、I420</p>
</li>
<li>
<p><strong>HSV</strong></p>
<p>更接近人类感知方式的颜色空间，由色相 H、饱和度 S、明度 V 组成。它更方便做颜色筛选、图像处理和调色等操作，广泛用于图像编辑软件、颜色选取工具和滤镜开发中</p>
</li>
<li>
<p><strong>Color Range</strong></p>
<p>表示颜色通道中像素值的取值范围，分为 full / limited range。full range 表示像素值从 0 ~ 255 全部可用，适用于图像编辑。limited range 只使用中间，比如 Y 范围是 16 ~ 235，UV 范围是 16 ~ 240，是为了兼容传统电视信号和视频标准，避免失真。视频编码常用 limited range，而图像处理常用 full range。如果编解码时 color range 不匹配，会导致图像发灰或对比度异常</p>
</li>
<li>
<p><strong>各种格式的使用场景</strong></p>
<ul>
<li>摄像头采集：结果一般是 YUV，更适合压缩，节省内存和带宽</li>
<li>图像处理：通常用 RGB，算法大多基于 RGB 设计，需要将 YUV 转换为 RGB</li>
<li>编码解码：H.264、H.265 通常要求输入 YUV 格式</li>
<li>图像显示：显示设备一般只支持 RGB，所有 YUV 视频都需要转为 RGB</li>
</ul>
</li>
<li>
<p><strong>RGB 和 YUV 之间的转换</strong></p>
<p>RGB 和 YUV 互转的标准规范有 BT709 和 BT601，图像的 color range 可能有两种，所以在做 RGB 往 YUV 转换的时候需要知道是哪个标准+ 哪种 Range</p>
<table>
  <thead>
      <tr>
          <th><strong>标准</strong></th>
          <th><strong>范围</strong></th>
          <th><strong>RGB → YUV 公式</strong></th>
          <th><strong>YUV → RGB 公式</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>BT.601</strong></td>
          <td><strong>Full</strong></td>
          <td>Y = 0.299R + 0.587G + 0.114B </td>
          <td></td>
      </tr>
      <tr>
          <td>U = -0.14713R - 0.28886G + 0.436B </td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>V = 0.615R - 0.51499G - 0.10001B</td>
          <td>R = Y + 1.13983V </td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>G = Y - 0.39465U - 0.58060V </td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>B = Y + 2.03211U</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><strong>BT.601</strong></td>
          <td><strong>Limited</strong></td>
          <td>Y = 16 + (65.481R + 128.553G + 24.966B)/255 </td>
          <td></td>
      </tr>
      <tr>
          <td>U = 128 + (-37.797R - 74.203G + 112.0B)/255</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>V = 128 + (112.0R - 93.786G - 18.214B)/255</td>
          <td>R = 1.164(Y − 16) + 1.596(V − 128) </td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>G = 1.164(Y − 16) − 0.392(V − 128) − 0.813(U − 128) </td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>B = 1.164(Y − 16) + 2.017(U − 128)</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><strong>BT.709</strong></td>
          <td><strong>Full</strong></td>
          <td>Y = 0.2126R + 0.7152G + 0.0722B </td>
          <td></td>
      </tr>
      <tr>
          <td>U = -0.1146R - 0.3854G + 0.5B </td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>V = 0.5R - 0.4542G - 0.0458B</td>
          <td>R = Y + 1.5748V </td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>G = Y - 0.1873U - 0.4681V </td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>B = Y + 1.8556U</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><strong>BT.709</strong></td>
          <td><strong>Limited</strong></td>
          <td>Y = 16 + (45.75R + 152.0G + 15.75B)/255 </td>
          <td></td>
      </tr>
      <tr>
          <td>U = 128 + (-25.5R - 129.0G + 154.5B)/255 </td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>V = 128 + (154.5R - 129.0G - 25.5B)/255</td>
          <td>R = 1.164(Y − 16) + 1.793(V − 128) </td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>G = 1.164(Y − 16) − 0.534(V − 128) − 0.213(U − 128) </td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>B = 1.164(Y − 16) + 2.115(U − 128)</td>
          <td></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
</li>
</ul>
</li>
<li>
<p>图像颜色空间：14 种 YUV 的类型和存储方式</p>
<ul>
<li>
<p><strong>YUV 采样类型</strong>：分为 444，422，420 三种类型，主要区别是 UV 分量像素点的个数和采集方式</p>
<p>444：每个像素拥有 1 个 Y 分量和 1 个 U 分量、1 个 V 分量</p>
<p>422：每个像素拥有 1 个 Y 分量和 0.5 个 U 分量、0.5 个 V 分量</p>
<p>420：每个像素拥有 1 个 Y 分量和 0.25 个 U 分量、0.25 个 V 分量</p>
<p><img src="image.png" alt="image.png"></p>
</li>
<li>
<p>**YUV 存储方式：**主要分为两大类 Planar 和 Packed</p>
<p><img src="image%201.png" alt="image.png"></p>
</li>
<li>
<p>总结一共有十四种排列方式</p>
<table>
  <thead>
      <tr>
          <th><strong>采样类型</strong></th>
          <th><strong>排列方式</strong></th>
          <th><strong>格式名</strong></th>
          <th><strong>内存结构描述</strong></th>
          <th><strong>特点与用途</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>4:4:4</td>
          <td>Planar</td>
          <td>YUV444P(I444)</td>
          <td>YYYYYYYY + UUUUUUUU + VVVVVVVV</td>
          <td>每像素都有完整 YUV，质量最好</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td>YUV444P(YV24)</td>
          <td>YYYYYYYY + VVVVVVVV + UUUUUUUU</td>
          <td>也是 YUV444P，只是U/V 顺序互换</td>
      </tr>
      <tr>
          <td>4:2:2</td>
          <td>Planar</td>
          <td>YUV422P(I422)</td>
          <td>YYYYYYYY + UUUU + VVVV</td>
          <td>水平减半采样，适中清晰度</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td>YUV422P(YV16)</td>
          <td>YYYYYYYY + VVVV + UUUU</td>
          <td>也是 YUV422P，只是U/V 顺序互换</td>
      </tr>
      <tr>
          <td></td>
          <td>Packed</td>
          <td>NV16</td>
          <td>YYYYYYYY + UVUVUVUV</td>
          <td>水平减半，无垂直压缩</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td>NV61</td>
          <td>YYYYYYYY + VUVUVUVU</td>
          <td>同 NV16 顺序不同</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td>YUY2</td>
          <td>Y0 U0 Y1 V0，Y2 U1 Y3 V1，….</td>
          <td>USB 摄像头、Windows 平台常用</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td>UYVY</td>
          <td>U0 Y0 V0 Y1，U1 Y2 V1 Y3，…</td>
          <td>与 YUY2 顺序不同</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td>YVYU</td>
          <td>Y0 V0 Y1 U0，Y2 V1 Y3 U1，…</td>
          <td>不常见变体</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td>VYUY</td>
          <td>V0 Y0 U0 Y1，V1 Y2 U1 Y3</td>
          <td>很少使用</td>
      </tr>
      <tr>
          <td>4:2:0</td>
          <td>Planar</td>
          <td>YU12(I420)</td>
          <td>YYYYYYYY + UUUU + VVVV</td>
          <td>垂直和水平均减半，主流压缩格式</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td>YV12</td>
          <td>YYYYYYYY + VVVV + UUUU</td>
          <td>I420 的变种，U/V 交换顺序</td>
      </tr>
      <tr>
          <td></td>
          <td>Packed</td>
          <td>NV12</td>
          <td>YYYYYYYY + UVUVUVUV</td>
          <td>Intel 平台和硬件编解码常用</td>
      </tr>
      <tr>
          <td></td>
          <td></td>
          <td>NV21</td>
          <td>YYYYYYYY + VUVUVUVU</td>
          <td>Android 默认格式</td>
      </tr>
  </tbody>
</table>
</li>
</ul>
</li>
<li>
<p>视频容器格式：MP4，FLV，MKV，MOV</p>
<p>经过 H.264 / H.265 编码后的视频本身只是压缩后的码流（bitstream），还不能单独作为一个可播放的文件，它通常需要被封装进容器格式，才成为一个完整的视频文件，除非通过特定工具 FFmpeg</p>
<table>
  <thead>
      <tr>
          <th><strong>格式</strong></th>
          <th><strong>类型</strong></th>
          <th><strong>支持的编码</strong></th>
          <th><strong>优点</strong></th>
          <th><strong>缺点</strong></th>
          <th><strong>适用场景</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>MP4</td>
          <td>通用容器</td>
          <td>H.264/H.265/AAC</td>
          <td>广泛兼容，压缩效率高</td>
          <td>不支持复杂菜单或多音轨</td>
          <td>网络视频、社交平台、移动设备</td>
      </tr>
      <tr>
          <td>MKV</td>
          <td>开源容器</td>
          <td>几乎所有编码格式</td>
          <td>支持多视频流、多音轨、多字幕</td>
          <td>某些设备支持度低</td>
          <td>高清视频存储、多语言影片</td>
      </tr>
      <tr>
          <td>MOV</td>
          <td>Apple 容器</td>
          <td>H.264/ProRes/AAC</td>
          <td>与 Apple 设备兼容性好</td>
          <td>文件大，跨平台兼容性差</td>
          <td>苹果设备、视频编辑</td>
      </tr>
      <tr>
          <td>FLV</td>
          <td>Flash 容器</td>
          <td>H.263/VP6/H264</td>
          <td>适合流媒体，文件小</td>
          <td>Flash 已淘汰，兼容性差</td>
          <td>旧版网页视频</td>
      </tr>
  </tbody>
</table>
<ul>
<li>**MP4：**常见的数字多媒体容器格式，用于存储视频、音频、字幕和图片等内容，几乎所有设备和操作系统（Windows、macOS、Android、iOS）都能支持。压缩效率高，减小文件大小</li>
<li><strong>MKV</strong>：支持多个视频流、音频流、字幕，适合高清电影和多语言视频文件的存储，几乎所有视频编码（如 H.264、VP9）和音频编码都兼容，通常用于存储高质量的影片，适合电影专业人员</li>
<li><strong>MOV</strong>：由 Apple 公司推出的多媒体容器格式，广泛用于 QuickTime 播放器中，支持视频、音频和字幕等，Apple 设备（如 macOS、iOS）中视频播放的标准格式</li>
<li><strong>FLV</strong>：由 Adobe 提出的 Flash 视频格式，主要用于在线视频流的传输和播放，通常需要 Flash Player 插件来播放，随着 HTML5 的普及，Flash 被逐步淘汰，FLV 格式也因此不再被广泛使用</li>
</ul>
</li>
<li>
<p>帧类型：I 帧，P 帧，B 帧，IDR 帧，GOP 图像组，Slice</p>
<p><img src="Untitled%202.png" alt="Untitled"></p>
<ul>
<li>
<p>**I 帧：**帧内编码帧，I表示关键帧，这一帧画面的完整保留，解码时只需要本帧数据就可以完成</p>
</li>
<li>
<p>**P 帧：**前向预测编码帧，表示的是这一帧跟前一个 I 帧或 P 帧的差别。具体方法是，以参考帧找出某点的预测差值和运动矢量一起传送，解码时，根据运动矢量从参考帧找出 P 帧某点的预测值并与差值相加以得到 P 帧某点样值，从而可得到完整的 P 帧</p>
</li>
<li>
<p>**B 帧：**双向预测内插编码帧，记录本帧与前后帧的差别。以前面的 I 或 P 帧和后面的 P 帧为参考帧，找出 B 帧某点的预测值和两个运动矢量一起传送。解码时根据运动矢量在两个参考帧中算出预测值并与差值相加，得到 B 帧某点样值，从而可得到完整的 B 帧。压缩率高，但解码开销大</p>
</li>
<li>
<p>**IDR 帧：**首个 I 帧叫 IDR，IDR 即时解码刷新 (Instantaneous Decoding Refresh)，I 和 IDR 帧是一样的，只是为了将首个 I 帧和其他 I 帧区别开。IDR 作用是立刻刷新，使错误不会一直传播（由于 P/B 帧需要参考其它帧。如果编解码过程中有一个参考帧出现错误，那依赖它的 P/B 帧肯定也会出错，而这些有问题的 P 帧又会继续作为之后 P/B 帧的参考帧）</p>
<p>H264 编码标准中规定，从 IDR 帧开始，重新算一个新的序列开始编码，DPB（参考帧列表）清空，在 IDR 帧之后的所有帧都不能引用任何 IDR 帧之前的帧的内容</p>
<p>播放器永远可以从一个 IDR 帧播放，因为在它之后没有任何帧引用之前的帧。但是，不能在一个没有 IDR 帧的视频中从任意点开始播放，因为后面的帧总是会引用前面的帧</p>
</li>
<li>
<p><strong>GOP 图像组</strong>：Group of Pictures，是视频编码中一组连续帧的结构单位，从一个 IDR 帧开始到下一个 IDR 帧的前一帧为止，这里面包含的 IDR 帧、普通 I 帧、P 帧和 B 帧</p>
<p>GOP 大的好处：I 帧越少，而P 帧、B 帧的压缩率更高，因此整个视频的编码效率就会越高</p>
<p>GOP 大的坏处：IDR 帧距离太大，点播场景的视频 seek 操作会不方便。而且 RTC 场景中，可能会因为网络原因丢包，导致接收端参考帧丢失而出现解码错误，从而引起长时间花屏和卡顿</p>
<p><img src="Untitled%203.png" alt="Untitled"></p>
</li>
<li>
<p><strong>Slice</strong>：一帧图像划分为数个 Slice，一个 Slice 又划分为数个宏块，宏块大小是 16 x 16。Slice 之间相互独立、互不依赖、独立编码，就可以多线程并行对多个 Slice 进行编码，从而提升速度。但因为一帧几个 Slice 是相互独立，所以如果帧内预测不能跨 Slice 进行，因此编码性能会差一些</p>
<p><img src="Untitled%204.png" alt="Untitled"></p>
</li>
</ul>
</li>
<li>
<p>Video pipeline 的数据格式转换表</p>
<table>
  <thead>
      <tr>
          <th><strong>阶段</strong></th>
          <th><strong>数据格式</strong></th>
          <th>文件名</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Capturer</td>
          <td>YUV / Texture</td>
          <td>.yuv</td>
      </tr>
      <tr>
          <td>Preview</td>
          <td>RGB / Texture</td>
          <td>.png、.bmp</td>
      </tr>
      <tr>
          <td>Encoder</td>
          <td>H.264 / H.265 / VP9</td>
          <td>.h264、.h265、bitstream</td>
      </tr>
      <tr>
          <td>Transport</td>
          <td>RTP / HLS / RTMP 包</td>
          <td>.pcap、.ts</td>
      </tr>
      <tr>
          <td>Decoder</td>
          <td>YUV / Texture</td>
          <td>.yuv</td>
      </tr>
      <tr>
          <td>Render</td>
          <td>RGB / Texture</td>
          <td>.png、.bmp</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>码流的结构和传输 Bitstream</p>
<ul>
<li><strong>码流的产生</strong>：由编码器生成的，经过压缩后的二进制数据流，包含了编码后的视频帧的所有信息</li>
<li>码流结构：指视频经过编码之后得到的二进制数据是怎么组织的，也就是说，怎么在在二进制码流数据中，分辨出哪一块数据是一帧图像，哪一块数据是另外一帧图像，H264 码流有两种格式：
<ul>
<li>**Annexb 格式：**使用起始码来表示一个编码数据的开始。起始码本身不是图像编码的内容，只是用来分隔用的。起始码有两种，一种是 4 字节的 00 00 00 01，一种是 3 字节的 00 00 01</li>
<li>**MP4 格式：**没有起始码，而是在图像编码数据的开始使用了 4 个字节作为长度标识，用来表示编码数据的长度，这样每次读取 4 个字节，计算出编码数据长度，然后取出编码数据</li>
</ul>
</li>
<li><strong>码流的传输</strong>：通常通过流媒体协议进行传输，例如直播视频流通过 RTP 或 RTSP 协议将压缩后的码流传输到接收端，传输通常考虑到带宽和延迟，可以采用自适应比特率传输（ABR）等技术</li>
<li><strong>码流的保存</strong>：音视频码流会被封装在容器中，方便存储和播放。容器不仅包含编码后的音视频数据，还包含字幕、元数据、章节信息等。例如，MP4 容器包含 H.264 视频码流和 AAC 音频码流</li>
<li><strong>码流的解码</strong>：接收端会使用相应的解码器来读取并解码码流，还原为原始的视频帧进行显示播放</li>
</ul>
</li>
</ul>
<h2 id="3-android-图像基础">3. Android 图像基础</h2>
<ul>
<li>
<p>Frame buffer 采集的流程</p>
<p>梳理了一下 capturer pipeline 的整个过程</p>
<ol>
<li><strong>Enuermation</strong>: 通过 CameraManager 枚举摄像头，通过 CameraCharacteristics 来获取摄像头数据，方向，支持的分辨率，帧率等，保存摄像头信息供后续使用</li>
<li><strong>Initialization</strong>: RtcpalVideoSourceDL 调用 capturer.create() 创建 capturer 实例，对应着创建 camera manager，并且使用 openCamera() 来创建 CameraDevice 的过程</li>
<li><strong>Capturing</strong>: CameraDevice 通过 createCaptureSession() 来创建 CaptureSession，在 buffer mode 下会使用 ImageReader 的 Surface，在 texture mode 会使用 SurfaceTexture，来与 CaptureSession 关联起来。  CaptureSession 创建好后通过 setRepeatingRequest() 来请求 frame，Camera HAL 也就是硬件层会把获取到的 frame 传到前面这两种 surface 所绑定的 BufferQueue 里面</li>
<li><strong>Frame delivering</strong>: BufferQueue 收到帧之后，会触发回调函数也就是 ImageReader.onImageAvailable() 或者 SurfaceTexture. OnFrameAvailableListener。这两个回调函数内部，又会调用两个 JNI 回调函数也就是 onCpuFrameCaptured() 或者 onGpuFrameCaptured() 传入 video source</li>
<li><strong>Frame buffer → Texture</strong>: 如果使用的是 texture mode 则还有一步就是 Camera HAL 将 frame buffer 写入 SurfaceTexture 内部的 GraphicBuffer 之后，SurfaceTexture 会把收到的帧通过 updateTexImage() 映射成绑定的 OpenGL texture（GLuint）</li>
</ol>
</li>
<li>
<p>SurfaceTexture 使用 EGL OpenGL ES 渲染的流程</p>
<ol>
<li>Camera 输出一帧到 SurfaceTexture，响应 SurfaceTexture.OnFrameAvailableListener 回调，可以通过把 frame buffer 映射到到一个 OpenGL texture</li>
<li>EGL 初始化，创建 EGLDisplay、EGLContext、EGLSurface，EGL 是管理 OpenGL 上下文和屏幕的桥梁</li>
<li>OpenGL 渲染这一帧：更新 SurfaceTexture 内容 updateTexImage()，获取帧的纹理矩阵 getTransformMatrix(), 通过 顶点着色器（Vertex Shader）和片元着色器（Fragment Shader）
绘制从 SurfaceTexture 拿到的纹理，eglSwapBuffers 显示到频幕上</li>
</ol>
</li>
</ul>
<h2 id="3-音视频传输协议"><strong>3. 音视频传输协议</strong></h2>
<ul>
<li>
<p>WebRTC 概念理解</p>
<p>Web Real-Time Communication</p>
<p>WebRTC 是浏览器内置的一个实时通信技术，能够让开发者在浏览器或者移动应用中，实现实时的音频、视频以及数据低延迟的传输，而无需额外插件(Flash)，以及在链接成功后不需要中转服务器</p>
<p>他提供了一套接口，开发者可以轻松的在浏览器构建端对端的实时通信，涵盖从 capture，preview，encoder，transport，decoder，render 整个 pipeline 的全过程</p>
<ul>
<li>在<strong>浏览器端</strong>（Chrome, Firefox, Safari 等），你可以直接使用 JavaScript 的 WebRTC API</li>
<li>在<strong>移动端</strong>，你可以使用 WebRTC 的 Android 或 iOS SDK 开发原生 app</li>
</ul>
</li>
<li>
<p>WebRTC 工作和连接的流程</p>
<p><img src="image%202.png" alt="image.png"></p>
<p><img src="image%203.png" alt="image.png"></p>
<p>Client1 发 SDP offer</p>
<ol>
<li>
<p>Client1 getUserMedia，获取 localStream</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="nx">localStream</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span> <span class="nx">audio</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">video</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span></span></code></pre></div><p>获取摄像头和麦克风权限</p>
<p>拿到本地媒体流，可进行本地预览</p>
</li>
<li>
<p>Client1 创建 PeerConnection 并添加到 localStream</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">pc1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RTCPeerConnection</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">localStream</span><span class="p">.</span><span class="nx">getTracks</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">track</span> <span class="p">=&gt;</span> <span class="nx">pc1</span><span class="p">.</span><span class="nx">addTrack</span><span class="p">(</span><span class="nx">track</span><span class="p">,</span> <span class="nx">localStream</span><span class="p">));</span>
</span></span></code></pre></div></li>
<li>
<p>Client1 创建 SDP offer，发给 Signaling Server，Signaling Server 把 SDP offer 转发给 Client2</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">offer</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">pc1</span><span class="p">.</span><span class="nx">createOffer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">pc1</span><span class="p">.</span><span class="nx">setLocalDescription</span><span class="p">(</span><span class="nx">offer</span><span class="p">);</span>
</span></span></code></pre></div></li>
</ol>
<p>Client2 回 SDP answer</p>
<ol>
<li>
<p>Client2 收到 offer，getUserMedia，获取 local stream ****</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="nx">localStream</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span> <span class="nx">audio</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">video</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span></span></code></pre></div></li>
<li>
<p>Client2 创建 PeerConnection 并添加到 localStream</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">pc2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RTCPeerConnection</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">localStream</span><span class="p">.</span><span class="nx">getTracks</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">track</span> <span class="p">=&gt;</span> <span class="nx">pc2</span><span class="p">.</span><span class="nx">addTrack</span><span class="p">(</span><span class="nx">track</span><span class="p">,</span> <span class="nx">localStream</span><span class="p">));</span>
</span></span></code></pre></div></li>
<li>
<p>Client2 使用 SDP offer 设置远端描述，准备接收媒体 ****</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">remoteDesc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RTCSessionDescription</span><span class="p">(</span><span class="nx">offer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">pc2</span><span class="p">.</span><span class="nx">setRemoteDescription</span><span class="p">(</span><span class="nx">remoteDesc</span><span class="p">);</span>
</span></span></code></pre></div></li>
<li>
<p>Client2 创建 SDP answer，并把 answer 发给 Signaling Server，Signaling Server 将 SDP answer 转发回 Client1</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">answer</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">pc2</span><span class="p">.</span><span class="nx">createAnswer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">pc2</span><span class="p">.</span><span class="nx">setLocalDescription</span><span class="p">(</span><span class="nx">answer</span><span class="p">);</span>
</span></span></code></pre></div></li>
<li>
<p>Client1 收到 SDP answer，设置远端描述</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">remoteDesc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RTCSessionDescription</span><span class="p">(</span><span class="nx">answer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">pc1</span><span class="p">.</span><span class="nx">setRemoteDescription</span><span class="p">(</span><span class="nx">remoteDesc</span><span class="p">);</span>
</span></span></code></pre></div><p>ICE Candidate 交换，建立连接，开始通信</p>
<ol>
<li>
<p>双方交换 ICE 候选</p>
<p>浏览器通过 ICE 框架获取可用的网络地址（NAT 穿透）</p>
<p>每当一个候选可用，就通过信令服务器转发给对方</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="nx">pc1</span><span class="p">.</span><span class="nx">addIceCandidate</span><span class="p">(</span><span class="nx">candidate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">pc2</span><span class="p">.</span><span class="nx">addIceCandidate</span><span class="p">(</span><span class="nx">candidate</span><span class="p">);</span>
</span></span></code></pre></div></li>
<li>
<p>连接建立，媒体流传输</p>
<p>点对点媒体连接建立后，音频/视频通过 SRTP 在 Client1 和 Client2 间直接传输，Signaling Server 不再参与任何数据</p>
</li>
</ol>
</li>
<li>
<p>理解 ICE candidate 和 NAT 内网穿透</p>
<ul>
<li>
<p><strong>NAT（Network Address Translation）</strong></p>
<p>是路由器用来让多个设备共享一个公网 IP 的机制，你的电脑在内网 IP 是 192.168.1.10，访问外网时，路由器会“转换”成公网 IP（比如 203.0.113.7）。这是为了 节省公网 IP 数量，提高安全性，因为外部访问不到你内网设备</p>
</li>
<li>
<p><strong>NAT Traversal 内网穿透</strong></p>
<p>多数用户都在 NAT 后，比如家用 WiFi，公司局域网等，无法直接点对点通信。而内网穿透是一种绕过 NAT 限制，让两个都在 NAT 背后的设备建立连接的技术</p>
</li>
<li>
<p><strong>ICE（Interactive Connectivity Establishment）</strong></p>
<p>ICE 是一套帮助 WebRTC 客户端“穿透 NAT，建立连接”的技术机制，过程依赖收集和测试多种ICE 候选地址，以实现内网穿透</p>
<ol>
<li>每个客户端会收集三类 ICE 候选地址</li>
<li>通过 Signaling Server 互换 ICE 候选地址</li>
<li>双方尝试所有候选对，自动检测哪一对能连通</li>
<li>成功了，就选最优路径连接</li>
</ol>
</li>
<li>
<p><strong>ICE Candidate</strong></p>
<p>就是浏览器尝试建立连接时收集到的一种可用地址，WebRTC 为了确保连接成功，会尽可能多收集几种地址，双方都收集这些候选地址，然后逐个尝试组合（A 的地址 + B 的地址）进行连接</p>
<table>
  <thead>
      <tr>
          <th><strong>类型</strong></th>
          <th><strong>名字</strong></th>
          <th><strong>来源</strong></th>
          <th><strong>作用</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>本地地址</td>
          <td>host</td>
          <td>自己电脑的局域网 IP</td>
          <td>最快，适用于同一网络</td>
      </tr>
      <tr>
          <td>公网映射地址</td>
          <td>server reflexive</td>
          <td>STUN 服务器获取</td>
          <td>用于告诉对方“我在公网是这个 IP/端口”</td>
      </tr>
      <tr>
          <td>中继地址</td>
          <td>relay</td>
          <td>TURN 服务器分配</td>
          <td>点对点失败时中继音视频数据</td>
      </tr>
  </tbody>
</table>
</li>
</ul>
</li>
<li>
<p>理解三种服务器：STUN/TURN/Signal server</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="o">+-----------+</span>         <span class="o">+--------------------+</span>         <span class="o">+-----------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span>  <span class="nx">Client</span> <span class="nx">A</span> <span class="o">|</span> <span class="o">&lt;---&gt;</span>   <span class="o">|</span>  <span class="nx">Signaling</span> <span class="nx">Server</span>  <span class="o">|</span> <span class="o">&lt;---&gt;</span>   <span class="o">|</span>  <span class="nx">Client</span> <span class="nx">B</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----------+</span>         <span class="o">+--------------------+</span>         <span class="o">+-----------+</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>                       <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>    <span class="nx">getUserMedia</span>       <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>    <span class="nx">createOffer</span>        <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|-----&gt;</span> <span class="nx">SDP</span> <span class="nx">offer</span> <span class="o">------&gt;</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>                       <span class="o">|</span> <span class="o">-----&gt;</span> <span class="nx">SDP</span> <span class="nx">offer</span> <span class="o">----------&gt;|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>                       <span class="o">|</span> <span class="o">&lt;-----</span> <span class="nx">SDP</span> <span class="nx">answer</span> <span class="o">----------|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|&lt;-----</span> <span class="nx">SDP</span> <span class="nx">answer</span> <span class="o">&lt;-----</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>                       <span class="o">|</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|&lt;-&gt;</span> <span class="nx">ICE</span> <span class="nx">Candidates</span> <span class="o">&lt;-&gt;</span> <span class="o">|</span> <span class="o">&lt;-&gt;</span>   <span class="nx">ICE</span> <span class="nx">Candidates</span> <span class="o">&lt;-&gt;</span>    <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>      <span class="o">|</span>                <span class="o">|</span>                <span class="o">|</span>            <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>      <span class="nx">V</span>                <span class="o">|</span>                <span class="nx">V</span>            <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>  <span class="o">+---------+</span>      <span class="o">+---------+</span>      <span class="o">+---------+</span>      <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>  <span class="o">|</span>  <span class="nx">STUN</span>   <span class="o">|</span>      <span class="o">|</span>  <span class="nx">TURN</span>   <span class="o">|</span>      <span class="o">|</span>  <span class="nx">STUN</span>   <span class="o">|</span>      <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>  <span class="o">+---------+</span>      <span class="o">+---------+</span>      <span class="o">+---------+</span>      <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>      <span class="o">|</span>                                 <span class="o">|</span>            <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>      <span class="o">|-----------</span> <span class="nx">P2P</span> <span class="k">if</span> <span class="nx">possible</span> <span class="o">-----|</span>            <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|</span>                  <span class="nx">Fallback</span> <span class="nx">to</span> <span class="nx">TURN</span>                   <span class="o">|</span>
</span></span><span class="line"><span class="cl">     <span class="o">|----------------------------------------------------&gt;|</span>
</span></span></code></pre></div><ul>
<li>**STUN Server：**告诉客户端自己在公网下的 IP/端口（为 NAT 穿透准备），便宜轻便</li>
<li><strong>TURN Server</strong>：当 NAT 穿透失败时，使用 TURN server 中转音视频数据代替直连。比如企业内防火墙、对称 NAT，客户端和对端都无法直接连接，只能通过 TURN。比较贵因为服务器需要更大的贷款，通常只作为 falback 使用</li>
<li><strong>Signaling server</strong>：帮助客户端交换 SDP 和 ICE 信息，建立连接用，只负责牵线搭桥，WebRTC 没规定你怎么实现 Signaling，只要能收发消息就行</li>
</ul>
</li>
<li>
<p>Webrtc demo link</p>
<p><a href="https://github.com/zcy530/WebrtcDemo/tree/main" target="_blank">https://github.com/zcy530/WebrtcDemo/tree/main</a></p>
<p>server.js</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">)(</span><span class="nx">http</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="s1">&#39;public&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="nx">socket</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;User connected:&#39;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">,</span> <span class="nx">room</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="sb"> joined room </span><span class="si">${</span><span class="nx">room</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">room</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;offer&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">offer</span><span class="p">,</span> <span class="nx">room</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">room</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;offer&#39;</span><span class="p">,</span> <span class="nx">offer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;answer&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">answer</span><span class="p">,</span> <span class="nx">room</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">room</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;answer&#39;</span><span class="p">,</span> <span class="nx">answer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ice-candidate&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">candidate</span><span class="p">,</span> <span class="nx">room</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">room</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ice-candidate&#39;</span><span class="p">,</span> <span class="nx">candidate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">http</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Signaling server running on http://localhost:3000&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><p>index.html</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;utf-8&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>WebRTC Demo<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>WebRTC Video Chat<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">video</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;localVideo&#34;</span> <span class="na">autoplay</span> <span class="na">muted</span> <span class="na">playsinline</span><span class="p">&gt;&lt;/</span><span class="nt">video</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">video</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;remoteVideo&#34;</span> <span class="na">autoplay</span> <span class="na">playsinline</span><span class="p">&gt;&lt;/</span><span class="nt">video</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;/socket.io/socket.io.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="s1">&#39;test-room&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">localVideo</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;localVideo&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">remoteVideo</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;remoteVideo&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">localStream</span><span class="p">,</span> <span class="nx">peer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="nx">startCall</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;offer&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">offer</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">await</span> <span class="nx">createPeer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="kr">await</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">setRemoteDescription</span><span class="p">(</span><span class="nx">offer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">answer</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">createAnswer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="kr">await</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">setLocalDescription</span><span class="p">(</span><span class="nx">answer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;answer&#39;</span><span class="p">,</span> <span class="nx">answer</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;answer&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">answer</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">await</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">setRemoteDescription</span><span class="p">(</span><span class="nx">answer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;ice-candidate&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">candidate</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">await</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">addIceCandidate</span><span class="p">(</span><span class="nx">candidate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error adding received ice candidate&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">async</span> <span class="kd">function</span> <span class="nx">startCall</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">await</span> <span class="nx">createPeer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">offer</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">createOffer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="kr">await</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">setLocalDescription</span><span class="p">(</span><span class="nx">offer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;offer&#39;</span><span class="p">,</span> <span class="nx">offer</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">async</span> <span class="kd">function</span> <span class="nx">createPeer</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">localStream</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span> <span class="nx">video</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">audio</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="nx">localVideo</span><span class="p">.</span><span class="nx">srcObject</span> <span class="o">=</span> <span class="nx">localStream</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">peer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RTCPeerConnection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">localStream</span><span class="p">.</span><span class="nx">getTracks</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">track</span> <span class="p">=&gt;</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">addTrack</span><span class="p">(</span><span class="nx">track</span><span class="p">,</span> <span class="nx">localStream</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">peer</span><span class="p">.</span><span class="nx">ontrack</span> <span class="o">=</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">remoteVideo</span><span class="p">.</span><span class="nx">srcObject</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">peer</span><span class="p">.</span><span class="nx">onicecandidate</span> <span class="o">=</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">candidate</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;ice-candidate&#39;</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">candidate</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></div></li>
<li>
<p>HTTP / HTTPS</p>
<p>HTTP 协议</p>
<p>超文本传输协议（HyperText Transfer Protocol），它是基于 TCP 协议的应用层传输协议，简单来说就是客户端和服务器进行数据传输的一种规则，是一种发布和接收 HTML 页面的方法。客户端给服务端发送 request，服务端返回 response</p>
<ul>
<li>HTTP 默认工作在 TCP 协议 80 端口，用户访问网站 http:<strong>//</strong> 打头的都是标准 HTTP 服务</li>
<li>HTTP 使用 TCP 三次握手建立连接，客户端和服务器需要交换3个包</li>
<li>HTTP是一种无状态协议, 不会对发送过的请求和相应的通信状态进行持久化处理，是为了保持 HTTP 协议的简单性，从而能够快速处理大量的事务，提高效率</li>
<li>HTTP 协议以明文方式发送内容，不提供任何方式的数据加密，如果攻击者截取了Web 浏览器和网站服务器之间的传输报文，就可以直接读懂其中的信息，因此，HTTP协议不适合传输一些敏感信息，比如：信用卡号、密码等支付信息</li>
</ul>
<p>HTTPS 协议</p>
<p>超文本传输加密协议（Hypertext Transfer Protocol Secure），是由 HTTP+SSL 协议构建的可加密传输、身份认证的网络传输协议，数据传输过程是加密的，安全性较好，可以保护交换数据的隐私与完整性。HTTPS 经由 HTTP 进行通信，利用 SSL/TLS 来加密数据包</p>
<ul>
<li>HTTPS  默认工作在 TCP 协议 443 端口</li>
<li>HTTPS 除了 TCP 三次握手建立连接的三个包，还要加上 SSL 握手的9个包，一共是12个包</li>
<li>网页以加密的方式传输，用协商的对称加密算法和密钥加密，保证数据机密性。用协商的hash算法进行数据完整性保护，保证数据不被篡改</li>
</ul>
</li>
<li>
<p>TCP/UDP</p>
<p>视频传输通常使用 UDP，但在某些特定场景下也会使用 TCP</p>
<ul>
<li>速度快延迟低：UDP是无连接协议，不需要三次握手和等待确认，适合实时性高的视频通话、直播</li>
<li>容错性强：视频传输能容忍部分丢包。比如丢了 1 帧，下一帧照样能解码，肉眼不一定能察觉</li>
<li>带宽效率高：UDP 不处理重传，不对乱序包排序，也不做流控，避免了大量 TCP 的开销</li>
</ul>
</li>
<li>
<p>RTP - Real-Time Transport Protocol</p>
<p>RTP是一种网络协议，专门用于传输实时音视频数据。RTP协议确保数据的有序传输并提供时间戳和序列号，用于同步音视频和检测数据包丢失。RTP通常与RTCP配合使用，用于实时多媒体通信中的数据传输，如视频会议、VoIP等</p>
</li>
<li>
<p>RTCP - RTP Control Protocol</p>
<p>RTCP是RTP的控制协议，主要用于监控数据传输质量，并向发送方提供反馈信息。RTCP可以传输数据包丢失、延迟、抖动等信息，帮助发送方调整数据流的传输速率和质量。它在确保实时通信的可靠性和质量方面起着关键作用</p>
</li>
<li>
<p>RTSP - Real-Time Streaming Protocol</p>
<p>RTSP是一种网络控制协议，主要用于控制流媒体服务器，支持命令如播放、暂停和停止。RTSP本身并不传输数据，它主要用于控制RTP传输流。因此，RTSP常用于点播系统、监控系统中，支持客户端对音视频流的灵活控制</p>
</li>
<li>
<p>RTMP - Real-Time Messaging Protocol</p>
<p>RTMP是由Adobe开发的协议，广泛应用于直播流媒体传输，特别是在Flash播放器中。RTMP支持低延迟的视频传输，常用于直播平台。尽管Flash的使用已经减少，但RTMP仍在许多直播平台上得到支持，用于在服务器和客户端之间传输音视频数据</p>
</li>
</ul>
<h2 id="4-视频编解码协议">4. 视频编解码协议</h2>
<ul>
<li>
<p>压缩的必要性</p>
<p>一个视频一秒钟不压缩的内存是 710 MB，相当于带宽需要 710 Mbps，编码之后的带宽是 2-10 Mbps，视频压缩的目的就是可以用尽量少的带宽，传送更高质量的图像</p>
<p>YUV420: 表示有 YUV 三个分量，每个像素有一个亮度分量，有 1/4 个 U 分量和 1/4 个 V 分量</p>
<p><img src="image%204.png" alt="image.png"></p>
</li>
<li>
<p>视频编码的步骤：分块，预测，转换，量化，熵编码</p>
<ol>
<li>
<p><strong>Devide 分块</strong></p>
<p>把一个图像分为一些大小相等的块，比如说 H264 里面宏块的大小就是 16x16， H265 里是 64x64，就可以适用于更大的图像比如 4K 之类的</p>
</li>
<li>
<p><strong>Prediction 预测</strong></p>
<p>用来处理空域和时域信息，通过预测得到的残差块相比原本的编码块，去除了大部分空间冗余信息和时间冗余信息。GOP 里面有大量的 I/B/P 帧，I 帧使用帧内预测，BP 帧使用 帧间预测。因为Teams 是实时的，所以一般不用 B 帧，只用 P 帧，像 I P P P P</p>
<ul>
<li>
<p><strong>帧内预测</strong>：去除了本帧的空间冗余，跟其他的帧没有关系，自己就能解。(1) 已编码完成的块中，找到将编码块的相邻的块，比如左边块、上边块、左上角块和右上角块，(2) 将相邻块与编码块相邻的像素，映射得到预测块，(3) 编码块减去预测块得到残差块，(4) 取所有算法计算出残差块中绝对值加起来最小的，为最后结果</p>
<p><img src="Untitled%205.png" alt="Untitled"></p>
</li>
<li>
<p><strong>帧间预测</strong>：将已编好的参考帧中每一个块作为对应预测块，用编码块与预测快做差值，得到残差块，取所有计算出的残差块中绝对值加起来最小的，为最后结果</p>
</li>
</ul>
</li>
<li>
<p><strong>DCT Transform 变换</strong></p>
<p>DCT 离散余弦变换，用来处理频域信息。人眼对于图像中高频信息(右下角，包含细节、纹理、噪声等) 的敏感度小于低频信息 (左上角，包含图像的亮度、颜色平滑变化等基本信息)。有的时候去除图像中的一些高频信息，人眼看起来差别不大</p>
<p><img src="image%205.png" alt="image.png"></p>
<p>$F(u) = \alpha(u) \sum_{x=0}^{N-1} f(x) \cdot \cos\left[ \frac{\pi (2x + 1) u}{2N} \right]$</p>
</li>
<li>
<p><strong>Quantization 量化</strong></p>
<p>按一定精度进行压缩，就是把大的数变成小的数，可以简单理解为除法，这样会出现更多的零，压缩效果更好，但也会带来失真。图像的失真主要来自量化这一步。QP（量化参数）越大，压缩越强，失真越明显，画质越差。QP 小，画质好但码率高。如果带宽低，就可以通过提高 QP 来控制输出的画质和码率</p>
</li>
<li>
<p><strong>Entropy Coding 熵编码</strong></p>
<p>根据不同数据出现的频率，使用更短的码给频率高的符号，长码给频率低的符号，从而减少整体数据量。比如有熵编码，霍夫曼编码，算术编码，在 264 里对于分辨率高一点的都用算术编码（arithmetic coding）来实现，因为复杂性比较高，压缩率比较高，用硬件实现的话收益就比较大。编码带来的压缩率就是 1/2 或者 1/4，也不会引入失真，因为这个过程是可逆的</p>
</li>
</ol>
</li>
<li>
<p>视频解码的步骤：熵解码，反量化，反变换，预测重建，去块，滤波</p>
<ol>
<li>熵解码：Decoder 这边是相反的，先解码，然后反量化反变换</li>
<li>滤波：因为他在量化或者预测的过程中可能会失真，引起一些块效应。所以再最后解码的部分他又加上了 deblocking 这个滤波，然后 H265 里面他又加上了 SAO 这种算法，为了这个图像主观看上去更好一些</li>
<li><strong>去块滤波器，环路滤波器</strong></li>
</ol>
</li>
<li>
<p>编码标准：H254, H265, H266, VP9, AV1, ProRes</p>
<table>
  <thead>
      <tr>
          <th><strong>编码格式</strong></th>
          <th><strong>全称</strong></th>
          <th><strong>特点</strong></th>
          <th><strong>应用场景</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>H.264</strong></td>
          <td>AVC</td>
          <td>平衡压缩率和兼容性，广泛使用</td>
          <td>MP4 视频、流媒体、微信、抖音等</td>
      </tr>
      <tr>
          <td><strong>H.265</strong></td>
          <td>HEVC</td>
          <td>同画质下比 H.264 更小，适合 4K/8K，但计算复杂度高</td>
          <td>4K/8K 视频、高清电视、Netflix</td>
      </tr>
      <tr>
          <td><strong>VP9</strong></td>
          <td>Google</td>
          <td>类似 H.265，YouTube 专用较多</td>
          <td>YouTube、Chrome 浏览器</td>
      </tr>
      <tr>
          <td><strong>AV1</strong></td>
          <td>AudioVideo 1</td>
          <td>开源免专利费，比 H.265 更高效</td>
          <td>YouTube、Netflix、新一代网络视频</td>
      </tr>
      <tr>
          <td><strong>ProRes</strong></td>
          <td>Apple ProRes</td>
          <td>保留高质量画质，压缩轻微，适合编辑</td>
          <td>Final Cut Pro</td>
      </tr>
      <tr>
          <td><strong>H.266</strong></td>
          <td>VVC</td>
          <td>下一代，比 H.265 压缩率再高 50%</td>
          <td>未来 8K、XR 等超高清视频场景</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>Video H.264 (AVC, Advanced Video Coding)</p>
<p>H.264 是目前最广泛使用的视频编码标准之一，提供高压缩比和良好的视频质量</p>
<p>基于以下主要技术框架</p>
<ul>
<li><strong>帧间预测（Inter prediction）</strong>：参考前后帧压缩冗余</li>
<li><strong>帧内预测（Intra prediction）</strong>：利用当前图像块内的空间冗余压缩</li>
<li><strong>变换（Transform）</strong>：通常是整数 DCT，压缩能量</li>
<li><strong>量化（Quantization）</strong>：控制码率/画质平衡</li>
<li><strong>熵编码（Entropy coding）</strong>：H.264 用 CAVLC/CABAC，H.265 只用 CABAC</li>
<li><strong>去块滤波器（Deblocking filter）</strong>：去除宏块边界伪影</li>
<li><strong>环路滤波（Loop filters）</strong>：如 SAO（H.265 特有），进一步增强主观质量</li>
</ul>
<p>主要的概念</p>
<ul>
<li><strong>宏块（Macroblock, 16x16）</strong>：最小处理单元</li>
<li><strong>预测单位（PU）</strong> 和 <strong>变换单位（TU）</strong> 与宏块绑定</li>
<li><strong>熵编码</strong>：CAVLC（baseline）或 CABAC（main/high）</li>
<li><strong>编码复杂度相对较低</strong>，适用于实时编码（如视频会议）</li>
</ul>
</li>
<li>
<p>Video H.265 (HEVC, High Efficiency Video Coding)</p>
<p>H.265 是 H.264 的继任者，提供了比 H.264 高 50% 的压缩比和更好的视频质量，在相同的图像质量下，可以比H.264减少约50%的带宽需求，适用于 4K 和 8K 视频传输</p>
<p><strong>H.265 特别增强的实现结构</strong></p>
<ul>
<li><strong>编码树单元（CTU, 最大 64x64）</strong>：替代 H.264 的宏块，更灵活</li>
<li><strong>树状划分（Quad-Tree）</strong>：CTU → Coding Unit（CU）→ Prediction Unit（PU）和 Transform Unit（TU）</li>
<li><strong>更多帧间预测模式</strong>：提升编码效率</li>
<li><strong>环路滤波器新增 SAO（Sample Adaptive Offset）</strong></li>
<li><strong>并行友好设计（Tiles/WPP）</strong>：适合多核处理器并发编码</li>
</ul>
</li>
<li>
<p>基本单位：Macroblock / Slice /  GOP / NALU</p>
<ul>
<li>
<p><strong>宏块 Macroblock</strong></p>
<p>视频编码技术的基本单元。H264 中，宏块的大小通常是 16×16 像素，如果是 YUV420，则表示一个 16×16 的亮度块，两个 8×8 的色度块。H265 引入了更灵活的单元划分概念，编码树单元 CTU，支持大小从 16×16 到 64×64 像素的宏块</p>
<p>视频帧被分成宏块后，可以分别对每个块执行编码操作，减少计算复杂度，提升压缩率</p>
</li>
</ul>
</li>
<li>
<p>SPS / PPS</p>
</li>
<li>
<p>Audio AAC (Advanced Audio Coding)</p>
<p>AAC是一种高效的音频编码格式，广泛应用于流媒体、数字广播和音乐压缩中。AAC提供了比MP3更高的音质和更好的压缩效率，尤其是在低码率下表现出色。因此，它被采用为许多流媒体平台和数字音频广播（DAB）的标准。</p>
</li>
<li>
<p>AV1 (AOMedia Video 1)</p>
<p>AV1是一种开源、免版税的视频编码格式，由AOMedia开发，旨在取代H.264和H.265。AV1在保持相同视频质量的情况下提供了更高的压缩效率，是流媒体平台未来的潜在标准，尤其在高分辨率和低带宽环境中优势明显。</p>
</li>
<li>
<p>VP9 (Google)</p>
<p>VP9是由Google开发的视频编码格式，主要用于YouTube等平台，作为H.265的开源替代方案。VP9提供了与H.265相当的压缩效率，但由于它是开源的，没有使用许可费用，因此在开源社区和非商业应用中受到青睐。</p>
</li>
<li>
<p>硬件加速</p>
<h2 id="如何使用"><strong>如何使用 <code>MediaCodec</code> 进行硬件加速？</strong></h2>
<p><code>MediaCodec</code> 主要依赖设备的 <strong>硬件编解码器</strong> 来实现 <strong>硬件加速</strong>。相比于纯软件解码（如 <code>FFmpeg</code> 的 <code>libx264</code>），硬件解码可以更高效、低功耗，适用于 <strong>视频播放器、视频通话、直播推流、视频录制</strong> 等场景。</p>
<hr>
<h2 id="一如何启用硬件加速"><strong>一、如何启用硬件加速？</strong></h2>
<h3 id="1-选择支持的硬件编解码器"><strong>1. 选择支持的硬件编解码器</strong></h3>
<p>Android 提供的 <code>MediaCodecList</code> 可以列出所有可用的编解码器。通常，名称带有 <code>OMX</code> 的表示硬件加速。例如：</p>
<ul>
<li><code>OMX.qcom.video.decoder.avc</code>（高通硬件 H.264 解码器）</li>
<li><code>OMX.google.h264.decoder</code>（Google 纯软件解码器，非硬件）</li>
</ul>
<h3 id="获取设备支持的硬件编解码器"><strong>获取设备支持的硬件编解码器</strong></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">CopyEdit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MediaCodecList</span><span class="w"> </span><span class="n">codecList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MediaCodecList</span><span class="p">(</span><span class="n">MediaCodecList</span><span class="p">.</span><span class="na">ALL_CODECS</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">MediaCodecInfo</span><span class="w"> </span><span class="n">codecInfo</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">codecList</span><span class="p">.</span><span class="na">getCodecInfos</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">codecInfo</span><span class="p">.</span><span class="na">isEncoder</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 只获取解码器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">codecInfo</span><span class="p">.</span><span class="na">getSupportedTypes</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&#34;Codec&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;支持的编解码器: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">codecInfo</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; -&gt; &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">type</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><hr>
<h3 id="2-选择合适的"><strong>2. 选择合适的 <code>MediaCodec</code></strong></h3>
<p>默认情况下，<code>MediaCodec.createDecoderByType(&quot;video/avc&quot;)</code> 会自动选择可用的 H.264 硬件解码器。但可以手动指定 <strong>硬件编解码器</strong>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">CopyEdit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">String</span><span class="w"> </span><span class="n">codecName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;OMX.qcom.video.decoder.avc&#34;</span><span class="p">;</span><span class="w"> </span><span class="c1">// 高通硬件解码器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MediaCodec</span><span class="w"> </span><span class="n">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaCodec</span><span class="p">.</span><span class="na">createByCodecName</span><span class="p">(</span><span class="n">codecName</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>如果设备不支持该硬件编解码器，可以回退到 <code>createDecoderByType()</code> 自动选择。</p>
<hr>
<h3 id="3-使用"><strong>3. 使用 <code>Surface</code> 进行零拷贝解码</strong></h3>
<p>当 <code>MediaCodec</code> 直接输出到 <code>Surface</code> 时，视频帧不会拷贝到 CPU 内存，而是直接由 GPU 渲染，提高性能。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">CopyEdit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Surface</span><span class="w"> </span><span class="n">surface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Surface</span><span class="p">(</span><span class="n">textureView</span><span class="p">.</span><span class="na">getSurfaceTexture</span><span class="p">());</span><span class="w"> </span><span class="c1">// TextureView</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MediaCodec</span><span class="w"> </span><span class="n">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaCodec</span><span class="p">.</span><span class="na">createDecoderByType</span><span class="p">(</span><span class="s">&#34;video/avc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MediaFormat</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaFormat</span><span class="p">.</span><span class="na">createVideoFormat</span><span class="p">(</span><span class="s">&#34;video/avc&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">codec</span><span class="p">.</span><span class="na">configure</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="n">surface</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// 绑定 Surface，启用硬件加速</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">codec</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></div><hr>
<h2 id="二硬件解码使用"><strong>二、硬件解码：使用 <code>MediaCodec</code> 进行 H.264 硬件解码</strong></h2>
<p><strong>目标</strong>：用 <code>MediaCodec</code> 通过硬件加速 <strong>解码</strong> H.264 视频流，并直接渲染到 <code>Surface</code> 上。</p>
<h3 id="解码流程"><strong>解码流程</strong></h3>
<ol>
<li><strong>初始化 <code>MediaCodec</code></strong>，绑定 <code>Surface</code></li>
<li><strong>读取 H.264 码流</strong></li>
<li><strong>将数据送入 <code>MediaCodec</code></strong></li>
<li><strong>从 <code>MediaCodec</code> 获取解码后的视频帧</strong></li>
<li><strong>输出到 <code>Surface</code> 进行显示</strong></li>
</ol>
<h3 id="代码示例"><strong>代码示例</strong></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">CopyEdit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 1. 创建 MediaCodec 解码器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MediaCodec</span><span class="w"> </span><span class="n">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaCodec</span><span class="p">.</span><span class="na">createDecoderByType</span><span class="p">(</span><span class="s">&#34;video/avc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 2. 配置解码器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MediaFormat</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaFormat</span><span class="p">.</span><span class="na">createVideoFormat</span><span class="p">(</span><span class="s">&#34;video/avc&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">codec</span><span class="p">.</span><span class="na">configure</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="n">surface</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w"> </span><span class="c1">// 绑定 Surface 以启用硬件加速</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 3. 开始解码</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">codec</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 4. 读取 H.264 码流（来自文件或流媒体）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">h264Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getH264Data</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 5. 获取输入缓冲区并写入数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">inputBufferIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codec</span><span class="p">.</span><span class="na">dequeueInputBuffer</span><span class="p">(</span><span class="n">10000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inputBufferIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">inputBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codec</span><span class="p">.</span><span class="na">getInputBuffer</span><span class="p">(</span><span class="n">inputBufferIndex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">inputBuffer</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">inputBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">h264Data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">codec</span><span class="p">.</span><span class="na">queueInputBuffer</span><span class="p">(</span><span class="n">inputBufferIndex</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">h264Data</span><span class="p">.</span><span class="na">length</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 6. 获取解码后的视频帧</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MediaCodec</span><span class="p">.</span><span class="na">BufferInfo</span><span class="w"> </span><span class="n">bufferInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MediaCodec</span><span class="p">.</span><span class="na">BufferInfo</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">outputBufferIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codec</span><span class="p">.</span><span class="na">dequeueOutputBuffer</span><span class="p">(</span><span class="n">bufferInfo</span><span class="p">,</span><span class="w"> </span><span class="n">10000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">outputBufferIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">codec</span><span class="p">.</span><span class="na">releaseOutputBuffer</span><span class="p">(</span><span class="n">outputBufferIndex</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// 直接渲染到 Surface</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>✅ <strong>关键点</strong>：</p>
<ul>
<li><strong>绑定 <code>Surface</code></strong>，可以直接渲染到 <code>TextureView</code>，减少 CPU 负担。</li>
<li><strong>使用 <code>queueInputBuffer()</code> 提交数据</strong>。</li>
<li><strong>使用 <code>releaseOutputBuffer()</code> 渲染</strong>，而不是手动取 <code>ByteBuffer</code>。</li>
</ul>
<hr>
<h2 id="三硬件编码使用"><strong>三、硬件编码：使用 <code>MediaCodec</code> 进行 H.264 硬件编码</strong></h2>
<p><strong>目标</strong>：使用 <code>MediaCodec</code> 进行 <strong>YUV → H.264 硬件编码</strong>，适用于 <strong>视频录制、直播推流</strong>。</p>
<h3 id="编码流程"><strong>编码流程</strong></h3>
<ol>
<li><strong>创建 <code>MediaCodec</code> 编码器</strong></li>
<li><strong>配置 <code>MediaFormat</code></strong></li>
<li><strong>喂入 <code>YUV</code> 数据</strong></li>
<li><strong>获取编码后的 <code>H.264</code> 数据</strong></li>
<li><strong>存储或推流</strong></li>
</ol>
<h3 id="代码示例-1"><strong>代码示例</strong></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">CopyEdit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 1. 创建 H.264 编码器</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MediaCodec</span><span class="w"> </span><span class="n">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaCodec</span><span class="p">.</span><span class="na">createEncoderByType</span><span class="p">(</span><span class="s">&#34;video/avc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 2. 配置编码参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MediaFormat</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaFormat</span><span class="p">.</span><span class="na">createVideoFormat</span><span class="p">(</span><span class="s">&#34;video/avc&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">format</span><span class="p">.</span><span class="na">setInteger</span><span class="p">(</span><span class="n">MediaFormat</span><span class="p">.</span><span class="na">KEY_BIT_RATE</span><span class="p">,</span><span class="w"> </span><span class="n">1000000</span><span class="p">);</span><span class="w">  </span><span class="c1">// 码率 1Mbps</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">format</span><span class="p">.</span><span class="na">setInteger</span><span class="p">(</span><span class="n">MediaFormat</span><span class="p">.</span><span class="na">KEY_FRAME_RATE</span><span class="p">,</span><span class="w"> </span><span class="n">30</span><span class="p">);</span><span class="w">     </span><span class="c1">// 帧率 30fps</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">format</span><span class="p">.</span><span class="na">setInteger</span><span class="p">(</span><span class="n">MediaFormat</span><span class="p">.</span><span class="na">KEY_COLOR_FORMAT</span><span class="p">,</span><span class="w"> </span><span class="n">MediaCodecInfo</span><span class="p">.</span><span class="na">CodecCapabilities</span><span class="p">.</span><span class="na">COLOR_FormatYUV420Flexible</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">format</span><span class="p">.</span><span class="na">setInteger</span><span class="p">(</span><span class="n">MediaFormat</span><span class="p">.</span><span class="na">KEY_I_FRAME_INTERVAL</span><span class="p">,</span><span class="w"> </span><span class="n">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 每秒 1 个 I 帧</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">codec</span><span class="p">.</span><span class="na">configure</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">MediaCodec</span><span class="p">.</span><span class="na">CONFIGURE_FLAG_ENCODE</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">codec</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 3. 获取输入缓冲区并写入 YUV 数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">inputBufferIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codec</span><span class="p">.</span><span class="na">dequeueInputBuffer</span><span class="p">(</span><span class="n">10000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inputBufferIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">inputBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codec</span><span class="p">.</span><span class="na">getInputBuffer</span><span class="p">(</span><span class="n">inputBufferIndex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">inputBuffer</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">inputBuffer</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">yuvData</span><span class="p">);</span><span class="w">  </span><span class="c1">// YUV420 数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">codec</span><span class="p">.</span><span class="na">queueInputBuffer</span><span class="p">(</span><span class="n">inputBufferIndex</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">yuvData</span><span class="p">.</span><span class="na">length</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">1000</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// 4. 获取 H.264 输出数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MediaCodec</span><span class="p">.</span><span class="na">BufferInfo</span><span class="w"> </span><span class="n">bufferInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MediaCodec</span><span class="p">.</span><span class="na">BufferInfo</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kt">int</span><span class="w"> </span><span class="n">outputBufferIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codec</span><span class="p">.</span><span class="na">dequeueOutputBuffer</span><span class="p">(</span><span class="n">bufferInfo</span><span class="p">,</span><span class="w"> </span><span class="n">10000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">outputBufferIndex</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ByteBuffer</span><span class="w"> </span><span class="n">outputBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">codec</span><span class="p">.</span><span class="na">getOutputBuffer</span><span class="p">(</span><span class="n">outputBufferIndex</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">h264Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">byte</span><span class="o">[</span><span class="n">bufferInfo</span><span class="p">.</span><span class="na">size</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">outputBuffer</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">h264Data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">codec</span><span class="p">.</span><span class="na">releaseOutputBuffer</span><span class="p">(</span><span class="n">outputBufferIndex</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// 5. 发送到 RTMP 推流、存储为 MP4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sendToRtmpServer</span><span class="p">(</span><span class="n">h264Data</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>✅ <strong>关键点</strong>：</p>
<ul>
<li><code>COLOR_FormatYUV420Flexible</code> 适用于硬件编码。</li>
<li><strong>设置 <code>KEY_I_FRAME_INTERVAL</code></strong> 以控制关键帧（影响流媒体延迟）。</li>
<li><code>queueInputBuffer()</code> 送入 <strong>YUV 数据</strong>，<code>dequeueOutputBuffer()</code> 取出 <strong>H.264 码流</strong>。</li>
</ul>
<hr>
<h2 id="四如何确认"><strong>四、如何确认 <code>MediaCodec</code> 在使用硬件加速？</strong></h2>
<ol>
<li>
<p><strong>检查编解码器名称</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">CopyEdit</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MediaCodec</span><span class="w"> </span><span class="n">codec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaCodec</span><span class="p">.</span><span class="na">createDecoderByType</span><span class="p">(</span><span class="s">&#34;video/avc&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="s">&#34;Codec&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;使用的编解码器: &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">codec</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></div><ul>
<li><code>OMX.google.h264.decoder</code> → <strong>软件解码</strong></li>
<li><code>OMX.qcom.video.decoder.avc</code> → <strong>硬件解码</strong></li>
</ul>
</li>
<li>
<p><strong>测量 CPU 占用率</strong></p>
<ul>
<li>硬件解码的 CPU 负载 <strong>显著低于</strong> 软件解码。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="总结"><strong>总结</strong></h2>
<ul>
<li><strong><code>MediaCodec</code> 默认会使用硬件编解码器</strong>，只需绑定 <code>Surface</code> 即可零拷贝渲染。</li>
<li><strong><code>MediaCodecList</code> 可列出支持的硬件编解码器</strong>，确保选择正确的 <code>OMX</code> 设备。</li>
<li><strong>硬件编码适用于视频录制、直播</strong>，配合 <code>MediaMuxer</code> 生成 MP4 或推流。</li>
<li><strong>使用 <code>Surface</code> 进行零拷贝，提高渲染效率，降低功耗</strong></li>
</ul>
</li>
</ul>
<h3 id="5-开源多媒体处理框架"><strong>5. 开源多媒体处理框架</strong></h3>
<ul>
<li>
<p>FFmpeg</p>
<p>FFmpeg 是一个强大的多媒体处理工具，支持音视频格式转换、编辑、录制和流媒体处理</p>
<h2 id="download">Download</h2>
<p><a href="https://ffmpeg.org/download.html" target="_blank">https://ffmpeg.org/download.html</a>，下载 <strong>&ldquo;Full&rdquo;</strong> 版本的 ZIP 文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">cd</span> <span class="nl">C</span><span class="p">:</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">caiyizhang</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">ffmpeg</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">version</span>
</span></span></code></pre></div><h2 id="command">Command</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">ffmpeg</span> <span class="p">[</span><span class="err">输入选项</span><span class="p">]</span> <span class="o">-</span><span class="n">i</span> <span class="p">[</span><span class="err">输入文件</span><span class="p">]</span> <span class="p">[</span><span class="err">输出选项</span><span class="p">]</span> <span class="p">[</span><span class="err">输出文件</span><span class="p">]</span>
</span></span></code></pre></div><h2 id="example">Example</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// 将 MP4 转换为 AVI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="n">input</span><span class="p">.</span><span class="n">mp4</span> <span class="n">output</span><span class="p">.</span><span class="n">avi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 将 MKV 转换为 MP4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="n">input</span><span class="p">.</span><span class="n">mkv</span> <span class="n">output</span><span class="p">.</span><span class="n">mp4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 改变帧率
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="n">input</span><span class="p">.</span><span class="n">mp4</span> <span class="o">-</span><span class="n">r</span> <span class="mi">30</span> <span class="n">output</span><span class="p">.</span><span class="n">mp4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 无损转换
</span></span></span><span class="line"><span class="cl"><span class="c1">// 如果不指定编解码器，FFmpeg 会默认重新编码，可能会损失质量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="n">input</span><span class="p">.</span><span class="n">mkv</span> <span class="o">-</span><span class="n">c</span> <span class="n">copy</span> <span class="n">output</span><span class="p">.</span><span class="n">mp4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 压缩视频
</span></span></span><span class="line"><span class="cl"><span class="c1">// libx265 使用 H.265 编码，-crf 28 控制质量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="n">input</span><span class="p">.</span><span class="n">mp4</span> <span class="o">-</span><span class="nl">c</span><span class="p">:</span><span class="n">v</span> <span class="n">libx265</span> <span class="o">-</span><span class="n">crf</span> <span class="mi">28</span> <span class="n">output</span><span class="p">.</span><span class="n">mp4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 调整分辨率到 1280x720
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="n">input</span><span class="p">.</span><span class="n">mp4</span> <span class="o">-</span><span class="n">vf</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1280</span><span class="o">:</span><span class="mi">720</span> <span class="n">output</span><span class="p">.</span><span class="n">mp4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 裁剪 640x480 居中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="n">input</span><span class="p">.</span><span class="n">mp4</span> <span class="o">-</span><span class="n">vf</span> <span class="s">&#34;crop=640:480:100:50&#34;</span> <span class="n">output</span><span class="p">.</span><span class="n">mp4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 顺时针旋转 90 度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="n">input</span><span class="p">.</span><span class="n">mp4</span> <span class="o">-</span><span class="n">vf</span> <span class="s">&#34;transpose=1&#34;</span> <span class="n">output</span><span class="p">.</span><span class="n">mp4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 剪辑视频
</span></span></span><span class="line"><span class="cl"><span class="c1">// -ss 开始时间，-to 结束时间，-c copy 直接剪辑不重新编码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ffmpeg</span> <span class="o">-</span><span class="n">i</span> <span class="n">input</span><span class="p">.</span><span class="n">mp4</span> <span class="o">-</span><span class="n">ss</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">30</span> <span class="o">-</span><span class="n">to</span> <span class="mo">00</span><span class="o">:</span><span class="mo">01</span><span class="o">:</span><span class="mo">00</span> <span class="o">-</span><span class="n">c</span> <span class="n">copy</span> <span class="n">output</span><span class="p">.</span><span class="n">mp4</span>
</span></span></code></pre></div><h2 id="parameter">Parameter</h2>
<p>FFmpeg 中的 output 参数非常多，但常用的主要涉及 编码器、比特率、分辨率、帧率、音视频流 等方面。以下是常见的 output 选项</p>
<table>
  <thead>
      <tr>
          <th><strong>类别</strong></th>
          <th><strong>参数</strong></th>
          <th><strong>用途</strong></th>
          <th><strong>示例</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>帧率</strong></td>
          <td><code>-r 30</code></td>
          <td>设置帧率为 30 FPS</td>
          <td><code>ffmpeg -i input.mp4 -r 30 output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-r 60</code></td>
          <td>设置帧率为 60 FPS</td>
          <td><code>ffmpeg -i input.mp4 -r 60 output.mp4</code></td>
      </tr>
      <tr>
          <td><strong>比特率</strong></td>
          <td><code>-b:v 2M</code></td>
          <td>视频比特率 2 Mbps</td>
          <td><code>ffmpeg -i input.mp4 -b:v 2M output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-b:a 192k</code></td>
          <td>音频比特率 192 kbps</td>
          <td><code>ffmpeg -i input.mp4 -b:a 192k output.mp4</code></td>
      </tr>
      <tr>
          <td><strong>分辨率</strong></td>
          <td><code>-vf scale=1280:720</code></td>
          <td>调整视频分辨率到 720p</td>
          <td><code>ffmpeg -i input.mp4 -vf scale=1280:720 output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-vf scale=-1:1080</code></td>
          <td>宽度自适应，高度固定 1080p</td>
          <td><code>ffmpeg -i input.mp4 -vf scale=-1:1080 output.mp4</code></td>
      </tr>
      <tr>
          <td><strong>视频编码</strong></td>
          <td><code>-c:v libx264</code></td>
          <td>使用 H.264 编码（常见）</td>
          <td><code>ffmpeg -i input.mp4 -c:v libx264 output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-c:v libx265</code></td>
          <td>使用 H.265 编码（更高压缩比）</td>
          <td><code>ffmpeg -i input.mp4 -c:v libx265 output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-c:v vp9</code></td>
          <td>使用 VP9 编码（适用于 WebM）</td>
          <td><code>ffmpeg -i input.mp4 -c:v vp9 output.webm</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-c:v copy</code></td>
          <td>不重新编码（最快、无损）</td>
          <td><code>ffmpeg -i input.mp4 -c:v copy output.mp4</code></td>
      </tr>
      <tr>
          <td><strong>硬件加速</strong></td>
          <td><code>-c:v h264_nvenc</code></td>
          <td>使用 NVIDIA GPU 硬件加速（H.264）</td>
          <td><code>ffmpeg -i input.mp4 -c:v h264_nvenc output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-c:v h264_qsv</code></td>
          <td>使用 Intel Quick Sync 硬件加速</td>
          <td><code>ffmpeg -i input.mp4 -c:v h264_qsv output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-c:v h264_amf</code></td>
          <td>使用 AMD GPU 硬件加速</td>
          <td><code>ffmpeg -i input.mp4 -c:v h264_amf output.mp4</code></td>
      </tr>
      <tr>
          <td><strong>音频编码</strong></td>
          <td><code>-c:a aac</code></td>
          <td>使用 AAC 音频编码（MP4 常见）</td>
          <td><code>ffmpeg -i input.mp4 -c:a aac output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-c:a mp3</code></td>
          <td>使用 MP3 编码</td>
          <td><code>ffmpeg -i input.mp4 -c:a mp3 output.mp3</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-c:a copy</code></td>
          <td>不重新编码（最快、无损）</td>
          <td><code>ffmpeg -i input.mp4 -c:a copy output.mp4</code></td>
      </tr>
      <tr>
          <td><strong>恒定质量因子</strong></td>
          <td><code>-crf 23</code></td>
          <td>控制 H.264 质量（0-51，值越小质量越高）</td>
          <td><code>ffmpeg -i input.mp4 -c:v libx264 -crf 23 output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-crf 28</code></td>
          <td>控制 H.265 质量（推荐 22-30）</td>
          <td><code>ffmpeg -i input.mp4 -c:v libx265 -crf 28 output.mp4</code></td>
      </tr>
      <tr>
          <td><strong>音视频流</strong></td>
          <td><code>-an</code></td>
          <td>去掉音频，仅保留视频</td>
          <td><code>ffmpeg -i input.mp4 -an output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-vn</code></td>
          <td>去掉视频，仅保留音频</td>
          <td><code>ffmpeg -i input.mp4 -vn output.mp3</code></td>
      </tr>
      <tr>
          <td><strong>剪辑</strong></td>
          <td><code>-ss 00:00:30 -to 00:01:00</code></td>
          <td>截取 00:30-01:00 片段</td>
          <td><code>ffmpeg -i input.mp4 -ss 00:00:30 -to 00:01:00 -c copy output.mp4</code></td>
      </tr>
      <tr>
          <td><strong>旋转</strong></td>
          <td><code>-vf &quot;transpose=1&quot;</code></td>
          <td>顺时针旋转 90°</td>
          <td><code>ffmpeg -i input.mp4 -vf &quot;transpose=1&quot; output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-vf &quot;transpose=2&quot;</code></td>
          <td>逆时针旋转 90°</td>
          <td><code>ffmpeg -i input.mp4 -vf &quot;transpose=2&quot; output.mp4</code></td>
      </tr>
      <tr>
          <td></td>
          <td><code>-vf &quot;transpose=1,transpose=1&quot;</code></td>
          <td>旋转 180°</td>
          <td><code>ffmpeg -i input.mp4 -vf &quot;transpose=1,transpose=1&quot; output.mp4</code></td>
      </tr>
      <tr>
          <td><strong>裁剪</strong></td>
          <td><code>-vf &quot;crop=640:480:100:50&quot;</code></td>
          <td>裁剪 640x480，起点 (100,50)</td>
          <td><code>ffmpeg -i input.mp4 -vf &quot;crop=640:480:100:50&quot; output.mp4</code></td>
      </tr>
      <tr>
          <td><strong>合并</strong></td>
          <td><code>-f concat -safe 0 -i file_list.txt -c copy</code></td>
          <td>合并多个相同编码的视频</td>
          <td><code>ffmpeg -f concat -safe 0 -i file_list.txt -c copy output.mp4</code></td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>x264</p>
<p>x264是一个开源的H.264视频编码器，以其高效的编码性能和灵活的参数设置著称。x264能够在高压缩比和高视频质量之间找到良好的平衡，广泛应用于视频流媒体、视频编辑和内容发布中。它也是FFmpeg中的一个重要组件，负责处理H.264编码任务。</p>
</li>
</ul>
<h3 id="6-客户端多媒体相关sdk">6. 客户端多媒体相关sdk</h3>
<ul>
<li>
<p>Android Camera 2 API</p>
<p>Camera 2是Android系统提供的高级相机API，支持手动控制相机的各项参数，如曝光时间、感光度、焦距等。它允许开发者创建高质量的相机应用，特别适用于需要精细控制拍摄效果的场景，如摄影应用、增强现实（AR）应用的开发等。相比旧版Camera API，Camera 2提供了更丰富的功能和更高的性能，但同时也更为复杂，需要开发者具备较高的技术水平。</p>
</li>
<li>
<p>Android Camera X API</p>
<p>CameraX 是 Android Jetpack 提供的一套用于摄像头开发的现代 API，封装了复杂的底层逻辑，提供了更一致、更高效的摄像头访问方式，并与生命周期紧密集成，简化了传统 Camera2 API</p>
<p><a href="https://developer.android.com/codelabs/camerax-getting-started?hl=zh-cn#3" target="_blank">https://developer.android.com/codelabs/camerax-getting-started?hl=zh-cn#3</a></p>
<p><strong>Camera 2</strong></p>
<p>在 camera 2 你需要手动管理下面的流程，更强的灵活性，但代码非常冗长</p>
<p>**用 Camera2 更适合：**需要对相机硬件高度控制的场景（比如 AI 相机，视频会议系统），多路输出、并行处理、低延迟预览、帧率自定义等高级功能，专业级 camera app 或定制设备</p>
<ul>
<li>
<p>CameraManager 用于获取设备</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">CameraManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">getSystemService</span><span class="p">(</span><span class="n">CameraManager</span><span class="p">.</span><span class="k">class</span><span class="err">);</span>
</span></span></code></pre></div></li>
<li>
<p>CameraDevice 用于打开相机</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">CameraDevice</span> <span class="n">device</span> <span class="o">=</span> <span class="n">manager</span><span class="p">.</span><span class="n">openCamera</span><span class="p">(...);</span>
</span></span></code></pre></div></li>
<li>
<p>CaptureRequest 用于设置参数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">CaptureRequest</span><span class="p">.</span><span class="n">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">createCaptureRequest</span><span class="p">(...);</span>
</span></span></code></pre></div></li>
<li>
<p>CameraCaptureSession 用于创建拍摄会话</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">CameraCaptureSession</span> <span class="n">session</span> <span class="o">=</span> <span class="n">device</span><span class="p">.</span><span class="n">createCaptureSession</span><span class="p">(...);</span>
</span></span><span class="line"><span class="cl"><span class="n">session</span><span class="p">.</span><span class="n">setRepeatingRequest</span><span class="p">(</span><span class="n">builder</span><span class="p">.</span><span class="n">build</span><span class="p">(),</span> <span class="p">...);</span>
</span></span></code></pre></div></li>
<li>
<p>Surface 用于管理图像输出</p>
</li>
</ul>
<p><strong>CameraX</strong></p>
<p>在 CameraX 对相机的操作又做了进一步的封装</p>
<p>用 CameraX 更适合：快速开发相机功能，普通拍照/录像/扫码，希望减少工作量和开发时间</p>
<ul>
<li>
<p>ProcessCameraProvider 作为 CameraX 的管理入口，负责绑定生命周期和 UseCase</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">val</span> <span class="n">cameraProviderFuture</span> <span class="o">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 这是异步的，需要添加监听器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">cameraProviderFuture</span><span class="p">.</span><span class="n">addListener</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="n">val</span> <span class="n">cameraProvider</span> <span class="o">=</span> <span class="n">cameraProviderFuture</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 后续步骤在此进行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">},</span> <span class="n">ContextCompat</span><span class="p">.</span><span class="n">getMainExecutor</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
</span></span></code></pre></div></li>
<li>
<p>CameraSelector 指定前/后摄像头</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">val</span> <span class="n">cameraSelector</span> <span class="o">=</span> <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span>
</span></span></code></pre></div></li>
<li>
<p>Preview 创建一个用于相机预览的 UseCase</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">val</span> <span class="n">preview</span> <span class="o">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">preview</span><span class="p">.</span><span class="n">setSurfaceProvider</span><span class="p">(</span><span class="n">previewView</span><span class="p">.</span><span class="n">surfaceProvider</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 将 use case 绑定到生命周期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">cameraProvider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">,</span> <span class="n">preview</span><span class="p">)</span>
</span></span></code></pre></div></li>
<li>
<p>ImageCapture 用于拍照</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">val</span> <span class="n">imageCapture</span> <span class="o">=</span> <span class="n">ImageCapture</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">setCaptureMode</span><span class="p">(</span><span class="n">ImageCapture</span><span class="p">.</span><span class="n">CAPTURE_MODE_MINIMIZE_LATENCY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</span></span></code></pre></div></li>
<li>
<p>ImageAnalysis 实时图像分析</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">val</span> <span class="n">imageAnalyzer</span> <span class="o">=</span> <span class="n">ImageAnalysis</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">setBackpressureStrategy</span><span class="p">(</span><span class="n">ImageAnalysis</span><span class="p">.</span><span class="n">STRATEGY_KEEP_ONLY_LATEST</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">imageAnalyzer</span><span class="p">.</span><span class="n">setAnalyzer</span><span class="p">(</span><span class="n">executor</span><span class="p">,</span> <span class="n">YourAnalyzer</span><span class="p">())</span>
</span></span></code></pre></div></li>
<li>
<p>PreviewView UI 组件，用于展示 Preview</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="o">&lt;</span><span class="n">androidx</span><span class="p">.</span><span class="n">camera</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">PreviewView</span>
</span></span><span class="line"><span class="cl">    <span class="nl">android</span><span class="p">:</span><span class="n">id</span><span class="o">=</span><span class="s">&#34;@+id/previewView&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">android</span><span class="p">:</span><span class="n">layout_width</span><span class="o">=</span><span class="s">&#34;match_parent&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nl">android</span><span class="p">:</span><span class="n">layout_height</span><span class="o">=</span><span class="s">&#34;match_parent&#34;</span> <span class="o">/&gt;</span>
</span></span></code></pre></div></li>
</ul>
<p><strong>对比</strong></p>
<table>
  <thead>
      <tr>
          <th>Camera2</th>
          <th>CameraX</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Surface</td>
          <td>PreviewView / SurfaceProvider</td>
          <td>Preview 通常显示在 PreviewView 上</td>
      </tr>
      <tr>
          <td>CameraManager</td>
          <td>ProcessCameraProvider</td>
          <td>负责查找和绑定相机设备</td>
      </tr>
      <tr>
          <td>CameraDevice</td>
          <td>内部封装，无需直接操作</td>
          <td>CameraX 内部管理打开的相机</td>
      </tr>
      <tr>
          <td>CaptureRequest</td>
          <td>UseCase (如 Preview, ImageCapture)</td>
          <td>每个 UseCase 相当于一个封装好的请求配置</td>
      </tr>
      <tr>
          <td>CameraCaptureSession</td>
          <td>自动管理，CameraX 内部创建</td>
          <td>UseCase 自动管理会话和 Surface</td>
      </tr>
      <tr>
          <td>ImageReader</td>
          <td>ImageAnalysis</td>
          <td>实时获取帧用于图像处理，比如人脸识别</td>
      </tr>
      <tr>
          <td>CameraCharacteristics</td>
          <td>CameraInfo</td>
          <td>查询相机方向、分辨率、支持特性等信息</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>Media3 ExoPlayer</p>
<p>ExoPlayer 是 Google 官方开源的 Android 媒体播放器库，支持多种格式流媒体</p>
<p><a href="https://developer.android.com/media/media3/exoplayer?hl=zh-cn" target="_blank">https://developer.android.com/media/media3/exoplayer?hl=zh-cn</a></p>
<ol>
<li>引入依赖</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-groovy" data-lang="groovy"><span class="line"><span class="cl"><span class="n">implementation</span> <span class="s1">&#39;androidx.media3:media3-exoplayer:1.3.1&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">implementation</span> <span class="s1">&#39;androidx.media3:media3-ui:1.3.1&#39;</span>
</span></span></code></pre></div><ol start="2">
<li>布局文件</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;com.google.android.exoplayer2.ui.PlayerViewandroid:id</span><span class="err">=&#34;@+id/player_view&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">android:layout_width=</span><span class="s">&#34;match_parent&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">android:layout_height=</span><span class="s">&#34;match_parent&#34;</span> <span class="nt">/&gt;</span>
</span></span></code></pre></div><ol start="3">
<li>初始化和播放</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">val</span> <span class="py">player</span> <span class="p">=</span> <span class="nc">ExoPlayer</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">build</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">playerView</span> <span class="p">=</span> <span class="n">findViewById</span><span class="p">&lt;</span><span class="n">PlayerView</span><span class="p">&gt;(</span><span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">player_view</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">playerView</span><span class="p">.</span><span class="n">player</span> <span class="p">=</span> <span class="n">player</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">mediaItem</span> <span class="p">=</span> <span class="nc">MediaItem</span><span class="p">.</span><span class="n">fromUri</span><span class="p">(</span><span class="s2">&#34;https://your.video.url/xxx.mp4&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">player</span><span class="p">.</span><span class="n">setMediaItem</span><span class="p">(</span><span class="n">mediaItem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">player</span><span class="p">.</span><span class="n">prepare</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">player</span><span class="p">.</span><span class="n">play</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">player</span><span class="p">.</span><span class="n">setPlaybackSpeed</span><span class="p">(</span><span class="m">1.5f</span><span class="p">)</span> <span class="c1">// 快速播放
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">player</span><span class="p">.</span><span class="n">repeatMode</span> <span class="p">=</span> <span class="nc">Player</span><span class="p">.</span><span class="n">REPEAT_MODE_ONE</span> <span class="c1">// 单个视频循环
</span></span></span></code></pre></div><ol start="4">
<li>获取系统支持的解码器，ExoPlayer 不实现编解码，而是通过 <code>MediaCodec</code> 使用系统硬件解码器</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">androidx</span><span class="p">.</span><span class="nx">media3</span><span class="p">.</span><span class="nx">exoplayer</span><span class="p">.</span><span class="nx">mediacodec</span><span class="p">.</span><span class="nx">MediaCodecUtil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">val</span> <span class="nx">h264Decoders</span> <span class="o">=</span> <span class="nx">MediaCodecUtil</span><span class="p">.</span><span class="nx">getDecoderInfos</span><span class="p">(</span><span class="s2">&#34;video/avc&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="c1">// H264
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">val</span> <span class="nx">h265Decoders</span> <span class="o">=</span> <span class="nx">MediaCodecUtil</span><span class="p">.</span><span class="nx">getDecoderInfos</span><span class="p">(</span><span class="s2">&#34;video/hevc&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="c1">// H265
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nx">h264Decoders</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Log</span><span class="p">.</span><span class="nx">d</span><span class="p">(</span><span class="s2">&#34;DecoderInfo&#34;</span><span class="p">,</span> <span class="s2">&#34;H264 Decoder: ${it.name}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">h265Decoders</span><span class="p">.</span><span class="nx">forEach</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Log</span><span class="p">.</span><span class="nx">d</span><span class="p">(</span><span class="s2">&#34;DecoderInfo&#34;</span><span class="p">,</span> <span class="s2">&#34;H265 Decoder: ${it.name}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ol start="5">
<li>监听播放状态</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="nx">player</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="nx">object</span> <span class="o">:</span> <span class="nx">Player</span><span class="p">.</span><span class="nx">Listener</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">override</span> <span class="nx">fun</span> <span class="nx">onPlaybackStateChanged</span><span class="p">(</span><span class="nx">state</span><span class="o">:</span> <span class="nx">Int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">when</span> <span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Player</span><span class="p">.</span><span class="nx">STATE_BUFFERING</span> <span class="o">-&gt;</span> <span class="nx">Log</span><span class="p">.</span><span class="nx">d</span><span class="p">(</span><span class="s2">&#34;ExoPlayer&#34;</span><span class="p">,</span> <span class="s2">&#34;Buffering&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Player</span><span class="p">.</span><span class="nx">STATE_READY</span> <span class="o">-&gt;</span> <span class="nx">Log</span><span class="p">.</span><span class="nx">d</span><span class="p">(</span><span class="s2">&#34;ExoPlayer&#34;</span><span class="p">,</span> <span class="s2">&#34;Ready to play&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Player</span><span class="p">.</span><span class="nx">STATE_ENDED</span> <span class="o">-&gt;</span> <span class="nx">Log</span><span class="p">.</span><span class="nx">d</span><span class="p">(</span><span class="s2">&#34;ExoPlayer&#34;</span><span class="p">,</span> <span class="s2">&#34;Playback ended&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Player</span><span class="p">.</span><span class="nx">STATE_IDLE</span> <span class="o">-&gt;</span> <span class="nx">Log</span><span class="p">.</span><span class="nx">d</span><span class="p">(</span><span class="s2">&#34;ExoPlayer&#34;</span><span class="p">,</span> <span class="s2">&#34;Idle&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">override</span> <span class="nx">fun</span> <span class="nx">onPlayerError</span><span class="p">(</span><span class="nx">error</span><span class="o">:</span> <span class="nx">PlaybackException</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Log</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="s2">&#34;ExoPlayer&#34;</span><span class="p">,</span> <span class="s2">&#34;Playback error: ${error.message}&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><ol start="6">
<li>释放资源</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">override</span> <span class="k">fun</span> <span class="nf">onStop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">onStop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">player</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></li>
<li>
<p>ijkplayer</p>
<p>ijkplayer 是 Bilibili 开源的基于 FFmpeg 封装的播放器，适合自定义解码器和更底层控制的场景</p>
<ol>
<li>引入依赖（使用 JitPack）</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-groovy" data-lang="groovy"><span class="line"><span class="cl"><span class="n">implementation</span> <span class="s1">&#39;tv.danmaku.ijk.media:ijkplayer-java:0.8.8&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">implementation</span> <span class="s1">&#39;tv.danmaku.ijk.media:ijkplayer-armv7a:0.8.8&#39;</span> <span class="c1">// 需根据架构选对应的 so
</span></span></span></code></pre></div><ol start="2">
<li>布局文件</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;tv.danmaku.ijk.media.widget.IjkVideoViewandroid:id</span><span class="err">=&#34;@+id/video_view&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">android:layout_width=</span><span class="s">&#34;match_parent&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">android:layout_height=</span><span class="s">&#34;match_parent&#34;</span> <span class="nt">/&gt;</span>
</span></span></code></pre></div><ol start="3">
<li>初始化和播放</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">val</span> <span class="py">videoView</span> <span class="p">=</span> <span class="n">findViewById</span><span class="p">&lt;</span><span class="n">IjkVideoView</span><span class="p">&gt;(</span><span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">video_view</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nc">IjkMediaPlayer</span><span class="p">.</span><span class="n">loadLibrariesOnce</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nc">IjkMediaPlayer</span><span class="p">.</span><span class="n">native_profileBegin</span><span class="p">(</span><span class="s2">&#34;libijkplayer.so&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">videoView</span><span class="p">.</span><span class="n">setVideoURI</span><span class="p">(</span><span class="nc">Uri</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&#34;https://your.video.url/xxx.mp4&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">videoView</span><span class="p">.</span><span class="n">start</span><span class="p">(</span>
</span></span></code></pre></div><ol start="4">
<li>释放资源</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">override</span> <span class="k">fun</span> <span class="nf">onStop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">onStop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">videoView</span><span class="p">.</span><span class="n">stopPlayback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></li>
<li>
<p>Media Codec</p>
<p>MediaCodec是Android系统提供的硬件加速视频编码和解码API，支持多种视频格式的编码和解码操作。使用MediaCodec，开发者可以高效地处理视频数据，如录制、播放、实时流媒体传输等。MediaCodec通过调用底层硬件解码器，提供了比软件解码更快、更省电的性能，特别适合需要处理大量视频数据的应用。</p>
</li>
<li>
<p>OpenGL ES</p>
<p>OpenGL ES是为嵌入式系统（如移动设备）设计的跨平台图形API，支持2D和3D图形渲染。它在移动游戏、增强现实、实时图形处理等领域广泛应用。OpenGL ES提供了对GPU的直接控制，使开发者能够创建高效、流畅的图形渲染效果。它适用于需要高性能图形处理的应用，如3D游戏、图形编辑工具等。</p>
</li>
<li>
<p>GPU Image</p>
<p>GPU Image是一个开源的iOS图像处理库，基于GPU加速，支持实时图像处理效果。开发者可以使用GPU Image轻松实现各种图像滤镜、特效，如模糊、锐化、色彩调整等。由于其利用了GPU的并行计算能力，GPU Image在处理复杂图像操作时比传统的CPU处理快得多，适合用于相机应用、照片编辑等需要高效图像处理的场景。</p>
</li>
<li>
<p>iOS AVFoundation</p>
<p>AVFoundation是iOS系统中的核心多媒体框架，提供了丰富的API用于音视频捕获、编辑、播放和导出。通过AVFoundation，开发者可以轻松实现视频录制、音频处理、图像合成等多媒体功能。它支持的功能包括音视频剪辑、滤镜应用、实时预览、格式转换等，非常适合用于开发复杂的多媒体应用。</p>
</li>
<li>
<p>Metal</p>
<p>Metal是Apple开发的底层图形和计算API，提供了对GPU的直接访问，支持高性能图形渲染和数据并行计算。相比OpenGL ES，Metal提供了更低的开销和更高的效率，使其适合开发需要复杂图形处理和计算的应用，如高质量3D游戏、AR应用、视频特效等。Metal的出现标志着Apple在图形和计算性能上的进一步提升，是iOS和macOS应用开发中的重要工具。</p>
</li>
</ul>
<h3 id="7-客户端开发">7. 客户端开发</h3>
<ul>
<li>
<p>概述</p>
<p><img src="image%206.png" alt="image.png"></p>
</li>
<li>
<p>Android Native</p>
<p>Android原生开发主要使用Java或Kotlin编程语言，利用Android SDK提供的API进行应用开发。原生开发可以访问设备的硬件和系统功能，如相机、传感器、蓝牙、文件系统等，因此能够实现高性能、低延迟的应用。原生开发的优点是对平台功能的全面支持和优化，但缺点是无法跨平台复用代码。</p>
</li>
<li>
<p>iOS Native</p>
<p>iOS原生开发主要使用Objective-C或Swift编程语言，利用Apple的iOS SDK进行开发。原生开发可以直接访问iOS设备的系统API和硬件功能，如Touch ID、Face ID、相机等，因此能够提供优质的用户体验和高性能。与Android原生开发类似，iOS原生开发也无法跨平台使用代码。</p>
</li>
<li>
<p>Xamarin</p>
<p>Xamarin是一种跨平台开发工具，使用C#编程语言开发Android和iOS应用。它允许开发者在共享代码库的基础上，编写一次代码并部署到多个平台，从而减少开发时间和维护成本。Xamarin提供了对平台原生API的访问能力，因此可以在保持跨平台的同时，利用平台特有的功能</p>
</li>
</ul>
<h3 id="8-音视频质量优化">8. 音视频质量优化</h3>
<ul>
<li>
<p>Jitter Buffer</p>
<p>抖动缓冲器（Jitter Buffer）是用于缓解网络抖动对音视频流的影响的技术。它通过在接收端引入少量延迟，缓冲一定数量的数据包，从而平滑传输中的不规则抖动，确保音视频流的连续性和播放质量。Jitter Buffer在实时通信、视频会议等需要稳定流媒体传输的场景中非常重要。</p>
</li>
<li>
<p>首屏时间（First Frame Time）优化方案</p>
</li>
<li>
<p>音视频同步怎么实现</p>
</li>
<li>
<p>SVC (Scalable Video Coding)</p>
<p>可伸缩视频编码（SVC）是一种支持多层次视频传输的技术，使得视频流可以根据网络状况动态调整质量。SVC通过编码多个分辨率、帧率和质量层次，使得在网络条件不佳时可以仅传输基本层，而在条件良好时则传输更高质量的增强层。SVC广泛应用于视频会议、流媒体服务中，以适应不同的网络条件和设备能力。</p>
</li>
<li>
<p>GCC (Google Congestion Control)</p>
<p>Google开发的拥塞控制算法（GCC）是WebRTC中的一个关键技术，用于管理音视频流的网络传输。GCC通过动态调整视频码率，适应网络带宽的变化，确保视频流在拥塞情况下仍能保持较高的质量和流畅性。它通过实时监测网络状态，做出迅速的响应，使得音视频通信更加可靠和高效。</p>
</li>
<li>
<p>FEC (Forward Error Correction)</p>
<p>前向纠错（FEC）是一种通过传输冗余数据来提高音视频流抗丢包能力的技术。在传输过程中，如果出现数据包丢失，接收端可以利用冗余数据进行重建，而不必重新请求丢失的数据包。FEC特别适用于网络条件较差、丢包率较高的环境中，如卫星通信、直播流媒体等。</p>
</li>
<li>
<p>Simulcast</p>
<p><strong>Simulcast（多码流传输）是一种在不同网络条件下同时传输多路视频流的技术，每路视频流具有不同的分辨率</strong>和码率。接收端可以根据自身的网络条件选择合适的码流进行播放，从而在保障视频质量的同时降低带宽需求。Simulcast广泛应用于视频会议和直播中，确保不同用户都能获得最佳的视频体验。</p>
</li>
<li>
<p>弱网对抗、带宽预测、拥塞控制、丢包对抗</p>
<p>在网络条件较差的情况下，音视频流媒体需要通过自适应技术进行优化。弱网对抗涉及调整传输码率和抖动缓冲，以减轻网络波动的影响。带宽预测通过分析历史数据和实时网络状态，预测未来的网络带宽变化，以调整视频流的传输策略。拥塞控制（如GCC）通过动态调整传输速率，避免网络过载，从而保持流畅的视频播放。丢包对抗通过FEC和自动重传请求（ARQ）等技术，减少丢包对视频质量的影响。</p>
</li>
<li>
<p>码控、压缩率、性能优化</p>
<p>在视频编码过程中，码率控制（码控）直接影响到视频质量和压缩效率。优化码控策略可以在保证视频质量的同时，最大限度地减少带宽和存储消耗。压缩率优化涉及在不显著影响视频质量的前提下，进一步减少视频文件的大小。性能优化包括提高编码器和解码器的运行效率，降低处理延迟，从而在低性能设备上也能实现流畅的视频处理。</p>
</li>
<li>
<p>视频花屏和卡顿分析</p>
<p><strong>花屏和卡顿是视频播放中常见的问题，通常由编码器和解码器的参数设置不当或硬件资源不足引起。通过分析花屏和卡顿</strong>的产生原因，可以调整视频流的编码参数（如比特率、关键帧间隔等）和渲染器的性能设置，以减少这些现象的发生。优化解码器的性能，使其能够更高效地处理视频数据，也有助于降低卡顿的发生频率</p>
</li>
</ul>

      </div>
      








  
  
  
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

      
    
        

        
          
        

        
        
      


<footer id="article-footer">
  <time id="article-last-updated" datetime="2025-07-06"><i class="icon icon-calendar"></i>&nbsp;Last updated: 2025-07-06</time>

  
    <a id="article-prev-link" href="/docs/video-compression/"><i class="icon icon-prev icon-colored"></i> Prev</a>
  

  
    <a id="article-next-link"  href="/docs/andriod-development/">Next <i class="icon icon-next icon-colored"></i></a>
  
</footer>
    </article>
    <aside id="toc">
  <span class="btn-close"><i class="icon icon-close"></i></span>
  <div class="sticky">
    <strong><i class="icon icon-toc"></i> On this page</strong>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-语言基础"><strong>1. 语言基础</strong></a></li>
    <li><a href="#2-图像视频基础">2. 图像视频基础</a></li>
    <li><a href="#3-android-图像基础">3. Android 图像基础</a></li>
    <li><a href="#3-音视频传输协议"><strong>3. 音视频传输协议</strong></a></li>
    <li><a href="#4-视频编解码协议">4. 视频编解码协议</a></li>
    <li><a href="#如何使用"><strong>如何使用 <code>MediaCodec</code> 进行硬件加速？</strong></a></li>
    <li><a href="#一如何启用硬件加速"><strong>一、如何启用硬件加速？</strong></a>
      <ul>
        <li><a href="#1-选择支持的硬件编解码器"><strong>1. 选择支持的硬件编解码器</strong></a></li>
        <li><a href="#获取设备支持的硬件编解码器"><strong>获取设备支持的硬件编解码器</strong></a></li>
        <li><a href="#2-选择合适的"><strong>2. 选择合适的 <code>MediaCodec</code></strong></a></li>
        <li><a href="#3-使用"><strong>3. 使用 <code>Surface</code> 进行零拷贝解码</strong></a></li>
      </ul>
    </li>
    <li><a href="#二硬件解码使用"><strong>二、硬件解码：使用 <code>MediaCodec</code> 进行 H.264 硬件解码</strong></a>
      <ul>
        <li><a href="#解码流程"><strong>解码流程</strong></a></li>
        <li><a href="#代码示例"><strong>代码示例</strong></a></li>
      </ul>
    </li>
    <li><a href="#三硬件编码使用"><strong>三、硬件编码：使用 <code>MediaCodec</code> 进行 H.264 硬件编码</strong></a>
      <ul>
        <li><a href="#编码流程"><strong>编码流程</strong></a></li>
        <li><a href="#代码示例-1"><strong>代码示例</strong></a></li>
      </ul>
    </li>
    <li><a href="#四如何确认"><strong>四、如何确认 <code>MediaCodec</code> 在使用硬件加速？</strong></a></li>
    <li><a href="#总结"><strong>总结</strong></a>
      <ul>
        <li><a href="#5-开源多媒体处理框架"><strong>5. 开源多媒体处理框架</strong></a></li>
      </ul>
    </li>
    <li><a href="#download">Download</a></li>
    <li><a href="#command">Command</a></li>
    <li><a href="#example">Example</a></li>
    <li><a href="#parameter">Parameter</a>
      <ul>
        <li><a href="#6-客户端多媒体相关sdk">6. 客户端多媒体相关sdk</a></li>
        <li><a href="#7-客户端开发">7. 客户端开发</a></li>
        <li><a href="#8-音视频质量优化">8. 音视频质量优化</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</aside>
  </main>
</div>

    <footer id="site-footer">
  
  <div id="site-footer-copyright">
    <a href="https://zcy530.github.io/" target="_blank">
      <i class="icon icon-copyright"></i> 2025 Caiyi Zhang
    </a>
  </div>

  
  <div id="site-footer-social">

    

    

    

    

  </div>

  
  <div id="site-footer-fund">

    

    

  </div>

  
  <div id="site-footer-love">
    Made with Hugo and Duracu <i class="icon icon-love icon-colored"></i> &nbsp;</a>
  </div>
</footer>
    






<script type="text/javascript" src="/js/base.min.js"></script>



  
  <script src="/js/component/docsearch.min.js"></script>
  <script type="application/javascript">
      docsearch({
          container: '#site-header-search',
          appId: '',
          indexName: '',
          apiKey: '',
      });
  </script>


<script type="application/javascript">
    if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js?2025-07-27')
            .catch(function(err) {console.error('ServiceWorker registration failed: ', err);});
    }
</script>
  </body>
</html>